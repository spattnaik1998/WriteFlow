<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>WriteFlow — Idea Distillation Engine</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,500;0,600;0,700;1,400;1,500&family=Inter:wght@300;400;500;600&family=Lora:ital,wght@0,400;0,500;1,400&display=swap" rel="stylesheet">

<style>
/* ===== RESET & ROOT ===== */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --bg-base:        #0f0e0d;
  --bg-sidebar:     #181512;
  --bg-center:      #111009;
  --bg-right:       #181512;
  --bg-card:        #1e1b16;
  --bg-card-hover:  #232019;
  --bg-input:       #141210;
  --border:         #2b2620;
  --border-hi:      #38322a;
  --amber:          #c9a84c;
  --amber-lt:       #e0c06a;
  --amber-dk:       #a0832e;
  --amber-glow:     rgba(201,168,76,0.10);
  --amber-glow2:    rgba(201,168,76,0.20);
  --amber-glow3:    rgba(201,168,76,0.35);
  --text-1:         #ede4d2;
  --text-2:         #b9ad9c;
  --text-3:         #8a7f6e;
  --text-4:         #574f42;
  --green-ok:       #4ade80;
  --sidebar-w:      280px;
  --right-w:        355px;
  --radius:         8px;
  --ease:           0.22s ease;
}

html, body { height: 100%; overflow: hidden; }

body {
  font-family: 'Inter', sans-serif;
  background: var(--bg-base);
  color: var(--text-1);
  display: flex;
  flex-direction: column;
  height: 100vh;
}

/* Grain overlay */
body::after {
  content: '';
  position: fixed;
  inset: 0;
  pointer-events: none;
  z-index: 9999;
  opacity: .028;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='300' height='300'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.75' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='300' height='300' filter='url(%23n)'/%3E%3C/svg%3E");
}

/* Scrollbars */
::-webkit-scrollbar { width: 3px; height: 3px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--border-hi); border-radius: 2px; }

/* ===== LAYOUT ===== */
.app {
  display: flex;
  height: 100vh;
  overflow: hidden;
}

/* ═══════════════════════════════════════
   SIDEBAR
═══════════════════════════════════════ */
.sidebar {
  width: var(--sidebar-w);
  min-width: var(--sidebar-w);
  background: var(--bg-sidebar);
  border-right: 1px solid var(--border);
  display: flex;
  flex-direction: column;
  overflow: hidden;
  transition: width .3s cubic-bezier(.4,0,.2,1), min-width .3s cubic-bezier(.4,0,.2,1);
  position: relative;
}
.sidebar.collapsed { width: 56px; min-width: 56px; }

.sidebar-header {
  padding: 18px 14px 16px;
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  justify-content: space-between;
  flex-shrink: 0;
}

.logo {
  display: flex;
  align-items: center;
  gap: 9px;
  text-decoration: none;
  overflow: hidden;
  white-space: nowrap;
}

.logo-icon {
  width: 30px;
  height: 30px;
  flex-shrink: 0;
  color: var(--amber);
  filter: drop-shadow(0 0 6px var(--amber-glow3));
}

.logo-text {
  font-family: 'Playfair Display', serif;
  font-size: 17px;
  font-weight: 600;
  color: var(--text-1);
  letter-spacing: -.3px;
}
.logo-text span { color: var(--amber); }

.collapse-btn {
  background: none;
  border: none;
  cursor: pointer;
  color: var(--text-4);
  padding: 5px;
  border-radius: 5px;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: var(--ease);
  flex-shrink: 0;
}
.collapse-btn:hover { color: var(--text-2); background: var(--border); }

.sidebar-body {
  flex: 1;
  overflow-y: auto;
  overflow-x: hidden;
  padding: 16px 0 12px;
}

.section-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0 14px 10px;
}
.section-label {
  font-size: 10px;
  font-weight: 600;
  letter-spacing: 1.6px;
  text-transform: uppercase;
  color: var(--text-4);
}

.add-book-btn {
  width: 22px;
  height: 22px;
  background: var(--amber-glow);
  border: 1px solid var(--amber-dk);
  border-radius: 50%;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  color: var(--amber);
  font-size: 15px;
  line-height: 1;
  transition: var(--ease);
}
.add-book-btn:hover {
  background: var(--amber-glow2);
  transform: scale(1.1);
  box-shadow: 0 0 8px var(--amber-glow3);
}

/* Book Cards */
.book-list {
  display: flex;
  flex-direction: column;
  gap: 3px;
  padding: 0 8px;
}

.book-card {
  display: flex;
  align-items: stretch;
  border-radius: var(--radius);
  cursor: pointer;
  transition: var(--ease);
  position: relative;
  overflow: hidden;
  border: 1px solid transparent;
}
.book-card:hover { background: var(--bg-card); border-color: var(--border); }
.book-card.active {
  background: var(--bg-card);
  border-color: var(--border-hi);
  box-shadow: 0 2px 12px rgba(0,0,0,.35), inset 0 0 0 1px var(--amber-glow);
}
.book-card.active::before {
  content: '';
  position: absolute;
  left: 0; top: 0; bottom: 0;
  width: 2px;
  background: linear-gradient(to bottom, var(--amber-lt), var(--amber-dk));
  border-radius: 2px;
}

.book-spine {
  width: 7px;
  flex-shrink: 0;
  border-radius: 4px 0 0 4px;
}

.book-info {
  padding: 10px 10px 10px 11px;
  flex: 1;
  min-width: 0;
}

.book-title {
  font-size: 12.5px;
  font-weight: 500;
  color: var(--text-1);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  line-height: 1.3;
}
.book-author {
  font-size: 11px;
  color: var(--text-3);
  margin-top: 2px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.progress-wrap {
  display: flex;
  align-items: center;
  gap: 6px;
  margin-top: 6px;
}
.progress-bar {
  flex: 1;
  height: 2px;
  background: var(--border);
  border-radius: 1px;
  overflow: hidden;
}
.progress-fill {
  height: 100%;
  background: linear-gradient(to right, var(--amber-dk), var(--amber));
  border-radius: 1px;
  transition: width .5s ease;
}
.progress-pct {
  font-size: 10px;
  color: var(--text-4);
}

/* Sidebar footer */
.sidebar-footer {
  padding: 12px 14px;
  border-top: 1px solid var(--border);
  flex-shrink: 0;
  display: flex;
  align-items: center;
  gap: 8px;
}
.sidebar-footer-avatar {
  width: 28px;
  height: 28px;
  border-radius: 50%;
  background: linear-gradient(135deg, var(--amber-dk), #6b4a1a);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 11px;
  font-weight: 600;
  color: var(--text-1);
  flex-shrink: 0;
}
.sidebar-footer-name {
  font-size: 12px;
  font-weight: 500;
  color: var(--text-3);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

/* ═══════════════════════════════════════
   CENTER PANEL
═══════════════════════════════════════ */
.center-panel {
  flex: 1;
  background: var(--bg-center);
  display: flex;
  flex-direction: column;
  overflow: hidden;
  border-right: 1px solid var(--border);
}

.center-header {
  padding: 16px 24px 0;
  border-bottom: 1px solid var(--border);
  flex-shrink: 0;
}

.book-bar {
  display: flex;
  align-items: baseline;
  gap: 10px;
  padding-bottom: 13px;
}
.book-bar-title {
  font-family: 'Playfair Display', serif;
  font-size: 19px;
  font-weight: 600;
  color: var(--text-1);
  letter-spacing: -.3px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.book-bar-author {
  font-size: 13px;
  color: var(--text-3);
  white-space: nowrap;
}

.tab-nav {
  display: flex;
  gap: 0;
}
.tab-btn {
  background: none;
  border: none;
  cursor: pointer;
  padding: 9px 16px;
  font-family: 'Inter', sans-serif;
  font-size: 13px;
  font-weight: 500;
  color: var(--text-3);
  position: relative;
  transition: color var(--ease);
  display: flex;
  align-items: center;
  gap: 6px;
  letter-spacing: .1px;
}
.tab-btn::after {
  content: '';
  position: absolute;
  bottom: -1px;
  left: 0; right: 0;
  height: 2px;
  background: var(--amber);
  transform: scaleX(0);
  transition: transform .22s cubic-bezier(.4,0,.2,1);
  border-radius: 1px;
}
.tab-btn:hover { color: var(--text-2); }
.tab-btn.active { color: var(--amber); }
.tab-btn.active::after { transform: scaleX(1); }

/* Tab Panes */
.tab-content {
  flex: 1;
  overflow: hidden;
  position: relative;
}
.tab-pane {
  position: absolute;
  inset: 0;
  overflow-y: auto;
  padding: 22px 24px 28px;
  opacity: 0;
  transform: translateY(6px);
  pointer-events: none;
  transition: opacity .22s ease, transform .22s ease;
}
.tab-pane.active {
  opacity: 1;
  transform: translateY(0);
  pointer-events: auto;
}

/* ═══════════════════════════════════════
   NOTES TAB
═══════════════════════════════════════ */
.chapter-row {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 14px;
}
.chapter-select {
  flex: 1;
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  color: var(--text-1);
  font-family: 'Inter', sans-serif;
  font-size: 13px;
  padding: 9px 34px 9px 12px;
  cursor: pointer;
  transition: var(--ease);
  outline: none;
  appearance: none;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%238a7f6e' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 10px center;
}
.chapter-select option { background: var(--bg-card); }
.chapter-select:focus {
  border-color: var(--amber-dk);
  box-shadow: 0 0 0 3px var(--amber-glow);
}

.btn-add-chapter {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  color: var(--text-3);
  font-family: 'Inter', sans-serif;
  font-size: 12px;
  padding: 9px 13px;
  cursor: pointer;
  white-space: nowrap;
  transition: var(--ease);
  display: flex;
  align-items: center;
  gap: 5px;
}
.btn-add-chapter:hover { color: var(--text-2); border-color: var(--border-hi); }

.notes-textarea {
  width: 100%;
  min-height: 190px;
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 10px;
  color: var(--text-1);
  font-family: 'Lora', serif;
  font-size: 14px;
  line-height: 1.82;
  padding: 16px 18px;
  resize: vertical;
  outline: none;
  transition: border-color var(--ease), box-shadow var(--ease);
}
.notes-textarea::placeholder { color: var(--text-4); font-style: italic; }
.notes-textarea:focus {
  border-color: var(--amber-dk);
  box-shadow: 0 0 0 3px var(--amber-glow);
}

.action-row {
  display: flex;
  flex-wrap: wrap;
  gap: 9px;
  margin-top: 13px;
}

/* Primary amber button */
.btn-amber {
  flex: 1;
  padding: 10px 18px;
  background: linear-gradient(135deg, #c9a84c 0%, #a07828 100%);
  border: none;
  border-radius: var(--radius);
  color: #18130a;
  font-family: 'Inter', sans-serif;
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  transition: var(--ease);
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 7px;
  box-shadow: 0 2px 14px rgba(201,168,76,.22), inset 0 1px 0 rgba(255,255,255,.12);
  letter-spacing: .2px;
}
.btn-amber:hover {
  background: linear-gradient(135deg, #dfc06a 0%, #c9a84c 100%);
  box-shadow: 0 4px 22px rgba(201,168,76,.42), inset 0 1px 0 rgba(255,255,255,.15);
  transform: translateY(-1px);
}
.btn-amber:active { transform: translateY(0); }
.btn-amber.loading {
  animation: amberPulse 1.4s ease-in-out infinite;
  pointer-events: none;
  cursor: wait;
}
@keyframes amberPulse {
  0%,100% { box-shadow: 0 2px 14px rgba(201,168,76,.22); }
  50%      { box-shadow: 0 4px 28px rgba(201,168,76,.55); }
}
@keyframes spin {
  from { transform: rotate(0deg); }
  to   { transform: rotate(360deg); }
}

/* Secondary button */
.btn-sec {
  padding: 10px 16px;
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  color: var(--text-2);
  font-family: 'Inter', sans-serif;
  font-size: 13px;
  font-weight: 500;
  cursor: pointer;
  transition: var(--ease);
  display: flex;
  align-items: center;
  gap: 7px;
}
.btn-sec:hover { border-color: var(--border-hi); color: var(--text-1); background: var(--bg-card-hover); }

/* Accordion */
.accordion-label {
  font-size: 10px;
  font-weight: 600;
  letter-spacing: 1.4px;
  text-transform: uppercase;
  color: var(--text-4);
  margin: 22px 0 10px;
}
.accordion { display: flex; flex-direction: column; gap: 5px; }

.accordion-item {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  overflow: hidden;
  transition: border-color var(--ease);
}
.accordion-item.open { border-color: var(--border-hi); }

.accordion-head {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 11px 13px;
  cursor: pointer;
  user-select: none;
  transition: background var(--ease);
}
.accordion-head:hover { background: var(--bg-card-hover); }

.acc-title {
  font-size: 12.5px;
  font-weight: 500;
  color: var(--text-2);
}
.acc-meta { font-size: 11px; color: var(--text-4); margin-top: 1px; }

.acc-chevron {
  color: var(--text-4);
  transition: transform .22s ease;
  flex-shrink: 0;
}
.accordion-item.open .acc-chevron { transform: rotate(180deg); }

.accordion-body {
  max-height: 0;
  overflow: hidden;
  transition: max-height .28s cubic-bezier(.4,0,.2,1);
}
.accordion-item.open .accordion-body { max-height: 250px; }

.acc-content {
  padding: 12px 13px 13px;
  border-top: 1px solid var(--border);
  font-family: 'Lora', serif;
  font-size: 13px;
  line-height: 1.72;
  color: var(--text-3);
}

/* ═══════════════════════════════════════
   IDEAS TAB
═══════════════════════════════════════ */
.themes-bar {
  display: flex;
  align-items: center;
  gap: 7px;
  flex-wrap: wrap;
  margin-bottom: 18px;
}
.themes-bar-label {
  font-size: 10px;
  font-weight: 600;
  letter-spacing: 1.2px;
  text-transform: uppercase;
  color: var(--text-4);
}
.theme-pill {
  padding: 4px 11px;
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 20px;
  font-size: 11.5px;
  color: var(--text-3);
  cursor: pointer;
  transition: var(--ease);
}
.theme-pill:hover, .theme-pill.active {
  background: var(--amber-glow);
  border-color: var(--amber-dk);
  color: var(--amber);
}

.ideas-grid {
  columns: 2;
  column-gap: 14px;
}

.idea-card {
  break-inside: avoid;
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 17px;
  margin-bottom: 14px;
  transition: border-color var(--ease), box-shadow var(--ease), transform var(--ease);
  animation: cardReveal .5s ease both;
}
.idea-card:nth-child(1) { animation-delay: 0s; }
.idea-card:nth-child(2) { animation-delay: .07s; }
.idea-card:nth-child(3) { animation-delay: .14s; }
.idea-card:nth-child(4) { animation-delay: .21s; }
@keyframes cardReveal {
  from { opacity: 0; transform: translateY(14px) scale(.98); }
  to   { opacity: 1; transform: translateY(0) scale(1); }
}
.idea-card:hover {
  border-color: var(--border-hi);
  box-shadow: 0 5px 20px rgba(0,0,0,.35);
  transform: translateY(-2px);
}

.idea-num {
  font-size: 10px;
  font-weight: 600;
  color: var(--amber);
  opacity: .7;
  letter-spacing: .6px;
  margin-bottom: 7px;
}
.idea-title {
  font-family: 'Playfair Display', serif;
  font-size: 15px;
  font-weight: 600;
  color: var(--text-1);
  line-height: 1.35;
  margin-bottom: 9px;
}
.idea-body {
  font-size: 12.5px;
  line-height: 1.72;
  color: var(--text-3);
  margin-bottom: 13px;
}
.idea-tags {
  display: flex;
  gap: 5px;
  flex-wrap: wrap;
  margin-bottom: 13px;
}
.idea-tag {
  font-size: 9.5px;
  font-weight: 500;
  padding: 2px 7px;
  background: var(--amber-glow);
  border: 1px solid var(--amber-glow2);
  border-radius: 4px;
  color: var(--amber-dk);
  letter-spacing: .3px;
}
.idea-explore {
  background: none;
  border: 1px solid var(--border-hi);
  border-radius: 5px;
  color: var(--text-3);
  font-family: 'Inter', sans-serif;
  font-size: 11.5px;
  padding: 5px 11px;
  cursor: pointer;
  transition: var(--ease);
  display: flex;
  align-items: center;
  gap: 5px;
}
.idea-explore:hover {
  border-color: var(--amber-dk);
  color: var(--amber);
  background: var(--amber-glow);
}

/* ═══════════════════════════════════════
   WRITE TAB
═══════════════════════════════════════ */
.write-toolbar {
  display: flex;
  gap: 3px;
  padding: 7px 10px;
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius) var(--radius) 0 0;
  border-bottom: none;
}
.toolbar-btn {
  background: none;
  border: none;
  color: var(--text-3);
  cursor: pointer;
  padding: 5px 9px;
  border-radius: 5px;
  font-family: 'Inter', sans-serif;
  font-size: 12px;
  font-weight: 500;
  transition: var(--ease);
  display: flex;
  align-items: center;
  gap: 4px;
}
.toolbar-btn:hover { color: var(--text-1); background: var(--border); }
.toolbar-sep { width: 1px; height: 18px; background: var(--border); align-self: center; margin: 0 3px; }

.write-area {
  min-height: 320px;
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 0 0 var(--radius) var(--radius);
  color: var(--text-1);
  font-family: 'Lora', serif;
  font-size: 15px;
  line-height: 1.88;
  padding: 24px 28px;
  outline: none;
  caret-color: var(--amber);
  transition: border-color var(--ease);
}
.write-area:focus { border-color: var(--amber-dk); }
.write-area:empty::before {
  content: 'Begin writing your synthesis here...';
  color: var(--text-4);
  font-style: italic;
  pointer-events: none;
}
.write-area h2 {
  font-family: 'Playfair Display', serif;
  font-size: 21px;
  font-weight: 600;
  color: var(--text-1);
  margin-bottom: 13px;
  line-height: 1.3;
}
.write-area blockquote {
  border-left: 3px solid var(--amber-dk);
  padding-left: 15px;
  color: var(--text-3);
  font-style: italic;
  margin: 16px 0;
}
.write-area p { margin-bottom: 12px; }

.export-row {
  display: flex;
  gap: 8px;
  margin-top: 12px;
  justify-content: flex-end;
}

/* ═══════════════════════════════════════
   RIGHT PANEL — AI PARTNER
═══════════════════════════════════════ */
.right-panel {
  width: var(--right-w);
  min-width: var(--right-w);
  background: var(--bg-right);
  border-left: 1px solid var(--border);
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

.right-header {
  padding: 14px 18px;
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  gap: 10px;
  flex-shrink: 0;
}
.status-dot {
  width: 8px;
  height: 8px;
  background: var(--green-ok);
  border-radius: 50%;
  flex-shrink: 0;
  animation: dotPulse 2.2s ease-in-out infinite;
}
@keyframes dotPulse {
  0%,100% { box-shadow: 0 0 0 0 rgba(74,222,128,.5); }
  60%      { box-shadow: 0 0 0 5px rgba(74,222,128,0); }
}
.right-hdr-info { flex: 1; }
.right-hdr-title {
  font-family: 'Playfair Display', serif;
  font-size: 14px;
  font-weight: 600;
  color: var(--text-1);
}
.right-hdr-sub { font-size: 11px; color: var(--text-4); margin-top: 1px; }

/* Chat */
.chat-section {
  flex: 1;
  display: flex;
  flex-direction: column;
  overflow: hidden;
  border-bottom: 1px solid var(--border);
  min-height: 0;
}
.chat-messages {
  flex: 1;
  overflow-y: auto;
  padding: 14px 14px 6px;
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.chat-msg { display: flex; flex-direction: column; gap: 3px; animation: msgIn .28s ease both; }
@keyframes msgIn {
  from { opacity: 0; transform: translateY(6px); }
  to   { opacity: 1; transform: translateY(0); }
}

.msg-sender {
  font-size: 9.5px;
  font-weight: 600;
  letter-spacing: .9px;
  text-transform: uppercase;
  color: var(--text-4);
  padding: 0 2px;
}
.chat-msg.user .msg-sender { text-align: right; }

.msg-bubble {
  padding: 9px 12px;
  font-size: 12.5px;
  line-height: 1.65;
  color: var(--text-2);
  max-width: 92%;
}
.chat-msg.ai .msg-bubble {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 3px 10px 10px 10px;
  align-self: flex-start;
}
.chat-msg.user .msg-bubble {
  background: var(--amber-glow2);
  border: 1px solid rgba(201,168,76,.25);
  border-radius: 10px 3px 10px 10px;
  align-self: flex-end;
  color: var(--text-1);
}
.msg-bubble em {
  color: var(--amber-lt);
  font-style: normal;
  font-weight: 500;
}

/* Typing indicator */
.typing-ind {
  display: flex;
  align-items: center;
  gap: 4px;
  padding: 9px 13px;
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 3px 10px 10px 10px;
  align-self: flex-start;
}
.t-dot {
  width: 5px;
  height: 5px;
  background: var(--text-4);
  border-radius: 50%;
  animation: tDot 1.1s ease-in-out infinite;
}
.t-dot:nth-child(2) { animation-delay: .18s; }
.t-dot:nth-child(3) { animation-delay: .36s; }
@keyframes tDot {
  0%,80%,100% { transform: scale(.65); opacity: .4; }
  40%          { transform: scale(1); opacity: 1; }
}

.chat-input-row {
  padding: 10px 14px 12px;
  display: flex;
  gap: 7px;
  flex-shrink: 0;
  align-items: flex-end;
}
.chat-input {
  flex: 1;
  background: var(--bg-input);
  border: 1px solid var(--border);
  border-radius: 9px;
  color: var(--text-1);
  font-family: 'Inter', sans-serif;
  font-size: 12.5px;
  padding: 8px 11px;
  resize: none;
  outline: none;
  min-height: 38px;
  max-height: 110px;
  line-height: 1.5;
  transition: border-color var(--ease), box-shadow var(--ease);
}
.chat-input::placeholder { color: var(--text-4); }
.chat-input:focus {
  border-color: var(--amber-dk);
  box-shadow: 0 0 0 3px var(--amber-glow);
}
.send-btn {
  width: 36px;
  height: 36px;
  background: linear-gradient(135deg, var(--amber), var(--amber-dk));
  border: none;
  border-radius: 8px;
  color: #14100a;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: var(--ease);
  flex-shrink: 0;
  box-shadow: 0 2px 8px rgba(201,168,76,.3);
}
.send-btn:hover {
  background: linear-gradient(135deg, var(--amber-lt), var(--amber));
  transform: scale(1.07);
  box-shadow: 0 4px 14px rgba(201,168,76,.5);
}

/* Blog Discoveries */
.blog-panel {
  flex-shrink: 0;
  max-height: 270px;
  overflow-y: auto;
  border-top: 1px solid var(--border);
  padding: 12px 14px 14px;
}
.blog-panel-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 10px;
}
.blog-panel-title {
  font-size: 10px;
  font-weight: 600;
  letter-spacing: 1.4px;
  text-transform: uppercase;
  color: var(--text-4);
}
.blog-searching {
  display: none;
  align-items: center;
  gap: 4px;
  font-size: 10px;
  color: var(--text-4);
}
.blog-searching.on { display: flex; }
.s-dot {
  width: 4px; height: 4px;
  background: var(--amber);
  border-radius: 50%;
  animation: tDot 1s ease-in-out infinite;
}
.s-dot:nth-child(2) { animation-delay: .14s; }
.s-dot:nth-child(3) { animation-delay: .28s; }

.blog-list { display: flex; flex-direction: column; gap: 7px; }
.blog-card {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 9px 11px;
  display: flex;
  align-items: flex-start;
  gap: 9px;
  transition: var(--ease);
  animation: msgIn .28s ease both;
}
.blog-card:hover { border-color: var(--border-hi); background: var(--bg-card-hover); }
.blog-favicon {
  width: 20px; height: 20px;
  border-radius: 4px;
  background: var(--border);
  flex-shrink: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 8px;
  font-weight: 700;
  color: var(--text-3);
  margin-top: 1px;
}
.blog-info { flex: 1; min-width: 0; }
.blog-card-title {
  font-size: 11.5px;
  font-weight: 500;
  color: var(--text-2);
  line-height: 1.4;
  margin-bottom: 2px;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
}
.blog-domain { font-size: 10px; color: var(--text-4); }
.blog-read {
  background: none;
  border: 1px solid var(--border);
  border-radius: 4px;
  color: var(--text-4);
  font-size: 10px;
  font-weight: 500;
  padding: 3px 8px;
  cursor: pointer;
  transition: var(--ease);
  white-space: nowrap;
  align-self: center;
  flex-shrink: 0;
}
.blog-read:hover { border-color: var(--amber-dk); color: var(--amber); }

/* ═══════════════════════════════════════
   MODAL
═══════════════════════════════════════ */
.modal-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.72);
  backdrop-filter: blur(6px);
  z-index: 1000;
  display: flex;
  align-items: center;
  justify-content: center;
  opacity: 0;
  pointer-events: none;
  transition: opacity .22s ease;
}
.modal-overlay.open { opacity: 1; pointer-events: auto; }

.modal {
  background: var(--bg-sidebar);
  border: 1px solid var(--border-hi);
  border-radius: 14px;
  padding: 28px;
  width: 440px;
  max-width: calc(100vw - 48px);
  transform: translateY(22px) scale(.97);
  transition: transform .26s cubic-bezier(.34,1.56,.64,1);
  box-shadow: 0 32px 80px rgba(0,0,0,.7), 0 0 0 1px rgba(201,168,76,.08);
}
.modal-overlay.open .modal { transform: translateY(0) scale(1); }

.modal-title {
  font-family: 'Playfair Display', serif;
  font-size: 19px;
  font-weight: 600;
  color: var(--text-1);
  margin-bottom: 4px;
}
.modal-sub { font-size: 13px; color: var(--text-3); margin-bottom: 22px; }

.form-group { margin-bottom: 15px; }
.form-label {
  display: block;
  font-size: 11.5px;
  font-weight: 500;
  color: var(--text-3);
  margin-bottom: 5px;
  letter-spacing: .2px;
}
.form-input, .form-ta {
  width: 100%;
  background: var(--bg-input);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  color: var(--text-1);
  font-family: 'Inter', sans-serif;
  font-size: 13px;
  padding: 9px 12px;
  outline: none;
  transition: border-color var(--ease), box-shadow var(--ease);
}
.form-input::placeholder, .form-ta::placeholder { color: var(--text-4); }
.form-input:focus, .form-ta:focus {
  border-color: var(--amber-dk);
  box-shadow: 0 0 0 3px var(--amber-glow);
}
.form-ta { min-height: 80px; resize: vertical; line-height: 1.6; }

.modal-actions {
  display: flex;
  gap: 9px;
  justify-content: flex-end;
  margin-top: 22px;
}
.btn-ghost {
  padding: 9px 17px;
  background: none;
  border: 1px solid var(--border);
  border-radius: 7px;
  color: var(--text-3);
  font-family: 'Inter', sans-serif;
  font-size: 13px;
  cursor: pointer;
  transition: var(--ease);
}
.btn-ghost:hover { color: var(--text-1); border-color: var(--border-hi); }

/* Tweet list inside modal */
.tweet-list { display: flex; flex-direction: column; gap: 10px; }
.tweet-item {
  background: var(--bg-input);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 12px 14px;
  font-size: 13.5px;
  color: var(--text-1);
  line-height: 1.6;
  position: relative;
  transition: border-color var(--ease);
}
.tweet-item:hover { border-color: var(--border-hi); }
.tweet-footer {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-top: 8px;
}
.tweet-char { font-size: 11px; color: var(--text-4); }
.tweet-char.warn { color: #e88; }
.tweet-copy {
  font-size: 11px;
  padding: 4px 10px;
  background: none;
  border: 1px solid var(--border);
  border-radius: 5px;
  color: var(--text-3);
  cursor: pointer;
  font-family: 'Inter', sans-serif;
  transition: var(--ease);
}
.tweet-copy:hover { border-color: var(--amber-dk); color: var(--amber); }
.tweet-copy.copied { color: var(--green-ok); border-color: var(--green-ok); }
.tweet-loading {
  text-align: center;
  padding: 32px 0;
  color: var(--text-3);
  font-size: 13px;
}
.tweet-spinner {
  width: 22px; height: 22px;
  border: 2px solid var(--border-hi);
  border-top-color: var(--amber);
  border-radius: 50%;
  animation: spin 0.9s linear infinite;
  margin: 0 auto 12px;
}

/* Thread viewer modal */
.thread-modal { width: 560px !important; }
.thread-modal-header {
  display: flex;
  align-items: flex-start;
  justify-content: space-between;
  gap: 12px;
  margin-bottom: 20px;
}
.thread-copy-all {
  flex-shrink: 0;
  margin-top: 4px;
  padding: 7px 14px;
  background: var(--amber-glow);
  border: 1px solid var(--amber-dk);
  border-radius: 6px;
  color: var(--amber);
  font-family: 'Inter', sans-serif;
  font-size: 12px;
  font-weight: 500;
  cursor: pointer;
  transition: var(--ease);
  display: flex;
  align-items: center;
  gap: 6px;
}
.thread-copy-all:hover { background: var(--amber-glow2); }
.thread-copy-all.copied { color: var(--green-ok); border-color: var(--green-ok); background: rgba(74,222,128,.08); }

.thread-list {
  display: flex;
  flex-direction: column;
  max-height: 58vh;
  overflow-y: auto;
  padding-right: 4px;
  padding-bottom: 4px;
}

.thread-item {
  display: flex;
  gap: 14px;
  padding-bottom: 0;
  position: relative;
}
/* Vertical connector line between tweets */
.thread-item:not(:last-child) .thread-spine::after {
  content: '';
  position: absolute;
  left: 15px;
  top: 38px;
  bottom: -4px;
  width: 2px;
  background: var(--border);
  border-radius: 1px;
}
.thread-spine {
  position: relative;
  display: flex;
  flex-direction: column;
  align-items: center;
  flex-shrink: 0;
  padding-bottom: 20px;
}
.thread-avatar {
  width: 32px;
  height: 32px;
  background: var(--bg-card);
  border: 1.5px solid var(--border-hi);
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  color: var(--text-3);
  font-size: 11px;
  font-weight: 700;
  flex-shrink: 0;
  z-index: 1;
}
.thread-avatar.hook {
  background: var(--amber-glow2);
  border-color: var(--amber-dk);
  color: var(--amber);
}
.thread-avatar.landing {
  background: rgba(74,222,128,.08);
  border-color: rgba(74,222,128,.4);
  color: var(--green-ok);
}

.thread-body {
  flex: 1;
  padding-bottom: 20px;
}
.thread-label {
  font-size: 9.5px;
  font-weight: 700;
  letter-spacing: 1px;
  text-transform: uppercase;
  color: var(--amber);
  margin-bottom: 5px;
}
.thread-label.land { color: var(--green-ok); }
.thread-text {
  font-size: 13.5px;
  color: var(--text-1);
  line-height: 1.65;
  margin-bottom: 8px;
  font-family: 'Lora', serif;
}
.thread-meta {
  display: flex;
  align-items: center;
  justify-content: space-between;
}
.thread-char { font-size: 11px; color: var(--text-4); }
.thread-char.warn { color: #e88; }

/* Success toast */
.toast {
  position: fixed;
  bottom: 28px;
  right: 28px;
  background: var(--bg-card);
  border: 1px solid var(--border-hi);
  border-left: 3px solid var(--amber);
  border-radius: var(--radius);
  padding: 12px 18px;
  font-size: 13px;
  color: var(--text-1);
  z-index: 2000;
  transform: translateY(60px);
  opacity: 0;
  transition: transform .3s cubic-bezier(.34,1.56,.64,1), opacity .3s ease;
  pointer-events: none;
  box-shadow: 0 8px 32px rgba(0,0,0,.4);
}
.toast.show { transform: translateY(0); opacity: 1; }

/* ===== THEME PILL HOVER ===== */
.theme-pill { cursor: pointer; }

/* ═══════════════════════════════════════
   STANCE BADGES
═══════════════════════════════════════ */
.stance-badge {
  display: inline-flex;
  align-items: center;
  font-size: 9px;
  font-weight: 600;
  letter-spacing: .5px;
  text-transform: uppercase;
  padding: 2px 7px;
  border-radius: 10px;
  margin-bottom: 4px;
  border: 1px solid;
}
.stance-badge.supporting {
  background: rgba(74,222,128,.10);
  border-color: rgba(74,222,128,.25);
  color: #4ade80;
}
.stance-badge.opposing {
  background: rgba(248,113,113,.10);
  border-color: rgba(248,113,113,.25);
  color: #f87171;
}
.stance-badge.neutral {
  background: var(--bg-card);
  border-color: var(--border);
  color: var(--text-4);
}

/* ═══════════════════════════════════════
   CONNECTIONS TAB
═══════════════════════════════════════ */
.connections-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 20px;
  flex-wrap: wrap;
  gap: 10px;
}
.connections-title {
  font-family: 'Playfair Display', serif;
  font-size: 16px;
  font-weight: 600;
  color: var(--text-1);
}
.connections-sub {
  font-size: 12px;
  color: var(--text-4);
  margin-top: 2px;
}

/* ── Knowledge Graph ── */
.kg-wrap { position: relative; }
.kg-svg  { display: block; overflow: visible; }

.kg-edge { transition: opacity .18s, stroke-width .18s; }

.kg-node-group { cursor: pointer; }
.kg-node-circle { transition: stroke-width .18s; }

.kg-node-text {
  font-family: 'Playfair Display', serif;
  font-size: 11.5px;
  font-weight: 600;
  fill: #ede4d2;
  pointer-events: none;
  dominant-baseline: middle;
  text-anchor: middle;
}
.kg-tag-text {
  font-family: 'Inter', sans-serif;
  font-size: 8px;
  font-weight: 700;
  letter-spacing: .9px;
  text-transform: uppercase;
  pointer-events: none;
  text-anchor: middle;
}
.kg-edge-label {
  font-family: 'Inter', sans-serif;
  font-size: 7.5px;
  letter-spacing: .5px;
  text-transform: uppercase;
  pointer-events: none;
  text-anchor: middle;
  dominant-baseline: middle;
}
.kg-legend {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  margin-top: 14px;
  padding-top: 12px;
  border-top: 1px solid var(--border);
}
.kg-legend-item {
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 10px;
  color: var(--text-3);
  letter-spacing: .3px;
}
.kg-legend-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }

.kg-tooltip {
  position: absolute;
  background: var(--bg-card);
  border: 1px solid var(--border-hi);
  border-radius: 10px;
  padding: 12px 14px;
  max-width: 230px;
  width: max-content;
  pointer-events: none;
  z-index: 10;
  font-size: 12px;
  line-height: 1.65;
  color: var(--text-2);
  box-shadow: 0 8px 28px rgba(0,0,0,.5);
  transition: opacity .15s;
}
.kg-tooltip-title {
  font-family: 'Playfair Display', serif;
  font-size: 13px;
  font-weight: 600;
  color: var(--text-1);
  margin-bottom: 6px;
}

/* Narrative output */
.narrative-section {
  margin-top: 24px;
  padding-top: 20px;
  border-top: 1px solid var(--border);
}
.narrative-label {
  font-size: 10px;
  font-weight: 600;
  letter-spacing: 1.6px;
  text-transform: uppercase;
  color: var(--text-4);
  margin-bottom: 14px;
}
.narrative-prose {
  border-left: 3px solid var(--amber-dk);
  padding-left: 18px;
  font-family: 'Lora', serif;
  font-size: 13.5px;
  line-height: 1.85;
  color: var(--text-2);
  font-style: italic;
}

.connections-empty {
  text-align: center;
  padding: 48px 20px;
  color: var(--text-4);
  font-size: 13px;
  line-height: 1.7;
}
.connections-empty svg { margin-bottom: 12px; opacity: .4; }

/* Library mode toggle */
.lib-mode-btn {
  background: none;
  border: 1px solid var(--border);
  border-radius: 6px;
  color: var(--text-4);
  font-family: 'Inter', sans-serif;
  font-size: 10.5px;
  font-weight: 500;
  padding: 4px 10px;
  cursor: pointer;
  transition: var(--ease);
  display: flex;
  align-items: center;
  gap: 5px;
  white-space: nowrap;
  flex-shrink: 0;
}
.lib-mode-btn:hover {
  color: var(--text-2);
  border-color: var(--border-hi);
}
.lib-mode-btn.active {
  background: var(--amber-glow);
  border-color: var(--amber-dk);
  color: var(--amber);
}
</style>
</head>
<body>

<div class="app">

  <!-- ═══════════ SIDEBAR ═══════════ -->
  <aside class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <a class="logo" href="#">
        <!-- Quill SVG -->
        <svg class="logo-icon" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M27 3C27 3 19 6 14.5 13C10 20 9 28 9 28L11.5 25.5C11.5 25.5 12.5 21 16 17" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
          <path d="M27 3L7 29" stroke="currentColor" stroke-width="1.4" stroke-linecap="round"/>
          <path d="M14.5 13C14.5 13 17 11 21 10C25 9 27 3 27 3C27 3 22 8 18 11C16 12 14.5 13 14.5 13Z" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round" fill="currentColor" fill-opacity="0.22"/>
          <circle cx="9" cy="28" r="1" fill="currentColor" opacity="0.6"/>
        </svg>
        <span class="logo-text">Write<span>Flow</span></span>
      </a>
      <button class="collapse-btn" onclick="toggleSidebar()" title="Toggle sidebar">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M15 18l-6-6 6-6"/>
        </svg>
      </button>
    </div>

    <div class="sidebar-body">
      <div style="padding: 0 0 8px">
        <div class="section-header">
          <span class="section-label">My Library</span>
          <button class="add-book-btn" onclick="openModal()" title="Add new book">+</button>
        </div>
        <div class="book-list" id="bookList"></div>
      </div>
    </div>

    <div class="sidebar-footer">
      <div class="sidebar-footer-avatar">R</div>
      <div class="sidebar-footer-name">Your Reading Space</div>
    </div>
  </aside>

  <!-- ═══════════ CENTER PANEL ═══════════ -->
  <main class="center-panel">
    <div class="center-header">
      <div class="book-bar">
        <div class="book-bar-title" id="barTitle">Thinking, Fast and Slow</div>
        <div class="book-bar-author" id="barAuthor">— Daniel Kahneman</div>
      </div>
      <nav class="tab-nav">
        <button class="tab-btn active" id="tabNotes" onclick="switchTab('notes')">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>
          Notes
        </button>
        <button class="tab-btn" id="tabIdeas" onclick="switchTab('ideas')">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
          Ideas
        </button>
        <button class="tab-btn" id="tabWrite" onclick="switchTab('write')">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
          Write
        </button>
        <button class="tab-btn" id="tabConnections" onclick="switchTab('connections')">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/></svg>
          Connections
        </button>
      </nav>
    </div>

    <div class="tab-content">

      <!-- NOTES TAB -->
      <div class="tab-pane active" id="pane-notes">
        <div class="chapter-row">
          <select class="chapter-select" id="chapterSelect">
            <option>Chapter 1 — Two Systems</option>
            <option>Chapter 2 — Attention and Effort</option>
            <option selected>Chapter 3 — The Lazy Controller</option>
            <option>Chapter 4 — The Associative Machine</option>
          </select>
          <button class="btn-add-chapter" onclick="addChapter()">
            <svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
            Chapter
          </button>
        </div>

        <textarea class="notes-textarea" id="mainNotes" rows="8" oninput="onNotesInput()">Kahneman opens with something brilliant — there are two ways we think. One is fast, automatic, like recognizing a face or reading anger in someone's voice. The other is slow, deliberate, like solving 17×24. The fast one (System 1) runs without us noticing. It's always on. The slow one (System 2) is lazy — it only engages when needed. Key: System 1 is constantly generating impressions and jumping to conclusions. System 2 mostly just endorses these without scrutiny. This is simultaneously terrifying and fascinating. The gorilla experiment. We don't see what we're not looking for.</textarea>

        <div class="action-row">
          <button class="btn-amber" id="distillBtn" onclick="distillIdeas()">
            <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 3H5a2 2 0 0 0-2 2v4m6-6h10a2 2 0 0 1 2 2v4M9 3v18m0 0h10a2 2 0 0 0 2-2V9M9 21H5a2 2 0 0 1-2-2V9m0 0h18"/></svg>
            Distill Ideas
          </button>
          <button class="btn-sec" onclick="findBlogArticles()">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
            Find Articles
          </button>
          <button class="btn-sec" id="tweetBtn" onclick="openTweetModal()">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 4s-.7 2.1-2 3.4c1.6 10-9.4 17.3-18 11.6 2.2.1 4.4-.6 6-2C3 15.5.5 9.6 3 5c2.2 2.7 5.5 4.3 9 4-.9-4.2 4-6.6 7-3.8 1.1 0 3-1.2 3-1.2z"/></svg>
            Tweet Ideas
          </button>
          <button class="btn-sec" id="threadBtn" onclick="openThreadModal()">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></svg>
            Build Thread
          </button>
        </div>

        <div class="accordion-label">Chapter Notes</div>
        <div class="accordion">
          <div class="accordion-item open" id="acc-1">
            <div class="accordion-head" onclick="toggleAcc('1')">
              <div>
                <div class="acc-title">Chapter 1 — Two Systems</div>
                <div class="acc-meta">64 words · 3 hours ago</div>
              </div>
              <svg class="acc-chevron" width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
            </div>
            <div class="accordion-body">
              <div class="acc-content">The book opens by establishing that human cognition is dual-layered. System 1 operates automatically — it reads emotions, recognizes faces, understands sentences without effort. System 2 is deliberate and expensive. The key insight: System 2 doesn't supervise System 1 continuously. It mostly accepts what System 1 presents.</div>
            </div>
          </div>

          <div class="accordion-item" id="acc-2">
            <div class="accordion-head" onclick="toggleAcc('2')">
              <div>
                <div class="acc-title">Chapter 2 — Attention & Effort</div>
                <div class="acc-meta">51 words · Yesterday</div>
              </div>
              <svg class="acc-chevron" width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
            </div>
            <div class="accordion-body">
              <div class="acc-content">Pupils dilate visibly during hard mental work — cognitive effort is literally physical. The battery metaphor: System 2 drains a finite resource. This is why important decisions made late in the day are worse. Ego depletion is real. Glucose restores deliberate thinking capacity. The implications for scheduling and decision-making are enormous.</div>
            </div>
          </div>

          <div class="accordion-item" id="acc-3">
            <div class="accordion-head" onclick="toggleAcc('3')">
              <div>
                <div class="acc-title">Chapter 3 — The Lazy Controller</div>
                <div class="acc-meta">48 words · 12 minutes ago</div>
              </div>
              <svg class="acc-chevron" width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
            </div>
            <div class="accordion-body">
              <div class="acc-content">We are cognitive misers by design. The bat and ball problem: $1.10 total, bat costs $1 more than the ball. Most say 10 cents. It's 5 cents. The intuitive answer feels fluent — and that fluency signals correctness to System 1. System 2 doesn't check unless prompted. This is WYSIATI in action.</div>
            </div>
          </div>
        </div>
      </div>

      <!-- IDEAS TAB -->
      <div class="tab-pane" id="pane-ideas">
        <div class="themes-bar">
          <span class="themes-bar-label">Themes</span>
          <span class="theme-pill active" onclick="togglePill(this)">Cognition</span>
          <span class="theme-pill" onclick="togglePill(this)">Decision-Making</span>
          <span class="theme-pill" onclick="togglePill(this)">Bias</span>
          <span class="theme-pill" onclick="togglePill(this)">Psychology</span>
          <span class="theme-pill" onclick="togglePill(this)">Behavior</span>
        </div>

        <div class="ideas-grid" id="ideasGrid">
          <div class="idea-card">
            <div class="idea-num">INSIGHT 01</div>
            <div class="idea-title">System 1 vs System 2 Thinking</div>
            <div class="idea-body">Human cognition runs on two parallel tracks. System 1 is automatic, instant, and constantly running — shaping almost every moment-to-moment perception. System 2 is deliberate and effortful, but dangerously passive: it tends to endorse whatever System 1 serves up, rarely questioning the source.</div>
            <div class="idea-tags">
              <span class="idea-tag">DUAL PROCESS</span>
              <span class="idea-tag">AUTOMATICITY</span>
            </div>
            <button class="idea-explore" onclick="exploreIdea('System 1 vs System 2')">
              <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M5 12h14m-7-7l7 7-7 7"/></svg>
              Explore Further
            </button>
          </div>

          <div class="idea-card">
            <div class="idea-num">INSIGHT 02</div>
            <div class="idea-title">The WYSIATI Principle</div>
            <div class="idea-body">What You See Is All There Is. System 1 constructs the most coherent narrative possible from available data — without ever noting what information is absent. This is why snap judgments feel complete and confident even when built on a fraction of what's relevant.</div>
            <div class="idea-tags">
              <span class="idea-tag">NARRATIVE BIAS</span>
              <span class="idea-tag">OVERCONFIDENCE</span>
            </div>
            <button class="idea-explore" onclick="exploreIdea('WYSIATI')">
              <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M5 12h14m-7-7l7 7-7 7"/></svg>
              Explore Further
            </button>
          </div>

          <div class="idea-card">
            <div class="idea-num">INSIGHT 03</div>
            <div class="idea-title">Anchoring Effect in Decision Making</div>
            <div class="idea-body">The first number encountered in any estimation contaminates all subsequent judgments — even when you know it's arbitrary. Kahneman showed that judges assigned shorter sentences after rolling low dice numbers. The anchor operates below the threshold of conscious awareness, making it nearly impossible to correct for.</div>
            <div class="idea-tags">
              <span class="idea-tag">ANCHORING</span>
              <span class="idea-tag">PRIMING</span>
              <span class="idea-tag">HEURISTICS</span>
            </div>
            <button class="idea-explore" onclick="exploreIdea('Anchoring Effect')">
              <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M5 12h14m-7-7l7 7-7 7"/></svg>
              Explore Further
            </button>
          </div>

          <div class="idea-card">
            <div class="idea-num">INSIGHT 04</div>
            <div class="idea-title">Cognitive Ease &amp; the Illusion of Truth</div>
            <div class="idea-body">When information is easy to process, we experience it as familiar, true, and credible. This is cognitive ease — and it's weaponizable. Repetition doesn't create truth, but it creates the <em>feeling</em> of truth. This is why propaganda relies on repetition, not argument. Fluency masquerades as validity.</div>
            <div class="idea-tags">
              <span class="idea-tag">COGNITIVE EASE</span>
              <span class="idea-tag">FLUENCY</span>
              <span class="idea-tag">TRUTH PERCEPTION</span>
            </div>
            <button class="idea-explore" onclick="exploreIdea('Cognitive Ease')">
              <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M5 12h14m-7-7l7 7-7 7"/></svg>
              Explore Further
            </button>
          </div>
        </div>
      </div>

      <!-- WRITE TAB -->
      <div class="tab-pane" id="pane-write">
        <div class="write-toolbar">
          <button class="toolbar-btn" onclick="execFmt('bold')" title="Bold">
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M6 4h8a4 4 0 0 1 4 4 4 4 0 0 1-4 4H6z"/><path d="M6 12h9a4 4 0 0 1 4 4 4 4 0 0 1-4 4H6z"/></svg>
            Bold
          </button>
          <button class="toolbar-btn" onclick="execFmt('italic')" title="Italic">
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="19" y1="4" x2="10" y2="4"/><line x1="14" y1="20" x2="5" y2="20"/><line x1="15" y1="4" x2="9" y2="20"/></svg>
            Italic
          </button>
          <div class="toolbar-sep"></div>
          <button class="toolbar-btn" onclick="execFmt('heading')" title="Heading">
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 12h16M4 6h7M4 18h7m7-12v12"/></svg>
            Heading
          </button>
          <button class="toolbar-btn" onclick="execFmt('blockquote')" title="Quote">
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 21c3 0 7-1 7-8V5c0-1.25-.756-2.017-2-2H4c-1.25 0-2 .75-2 1.972V11c0 1.25.75 2 2 2 1 0 1 0 1 1v1c0 1-1 2-2 2s-1 .008-1 1.031V20c0 1 0 1 1 1z"/><path d="M15 21c3 0 7-1 7-8V5c0-1.25-.757-2.017-2-2h-4c-1.25 0-2 .75-2 1.972V11c0 1.25.75 2 2 2h.75c0 2.25.25 4-2.75 4v3c0 1 0 1 1 1z"/></svg>
            Quote
          </button>
          <div class="toolbar-sep"></div>
          <button class="toolbar-btn" style="color:var(--amber-dk)" onclick="requestAISuggest()">
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>
            AI Suggest
          </button>
        </div>

        <div class="write-area" id="writeArea" contenteditable="true">
          <h2>The Hidden Architecture of Thought</h2>
          <p>Daniel Kahneman's central thesis is deceptively simple: we do not think as much as we believe we do. The mind operates on two parallel systems — one fast and automatic, one slow and deliberate — and the deliberate one is far more passive than our self-image suggests.</p>
          <blockquote>What You See Is All There Is. The mind builds coherent stories from available information, never asking what might be missing from the picture.</blockquote>
          <p>The implications cascade outward. If System 1 generates the vast majority of our judgments, and System 2 mostly just endorses them, then our cherished sense of careful deliberation is largely an illusion. We are not rational agents who occasionally err. We are intuitive agents who occasionally reflect.</p>
        </div>

        <div class="export-row">
          <button class="btn-sec" style="font-size:12px" onclick="exportMd()">
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
            Export Markdown
          </button>
          <button class="btn-amber" style="flex:0;padding:9px 15px;font-size:12px" onclick="exportPdf()">
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
            Export PDF
          </button>
        </div>
      </div>

      <!-- CONNECTIONS TAB -->
      <div class="tab-pane" id="pane-connections">
        <div class="connections-header">
          <div>
            <div class="connections-title">Knowledge Map</div>
            <div class="connections-sub" id="kgSubtitle">Concept connections for the current book</div>
          </div>
          <button class="btn-amber" id="narrativeBtn" onclick="generateNarrative()" style="flex:0;padding:9px 14px;font-size:12px">
            <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>
            Generate Macro Narrative
          </button>
        </div>
        <div id="themeClusters"></div>
        <div id="narrativeOutput" style="display:none">
          <div class="narrative-section">
            <div class="narrative-label">Macro Narrative</div>
            <div class="narrative-prose" id="narrativeProse"></div>
          </div>
        </div>
      </div>

    </div><!-- /tab-content -->
  </main>

  <!-- ═══════════ RIGHT PANEL ═══════════ -->
  <aside class="right-panel">
    <div class="right-header">
      <div class="status-dot"></div>
      <div class="right-hdr-info">
        <div class="right-hdr-title">Reading Partner</div>
        <div class="right-hdr-sub">Ready to explore ideas with you</div>
      </div>
      <button class="lib-mode-btn" id="libModeBtn" onclick="toggleLibraryMode()" title="Toggle Library Mode — gives the AI context from all your books">
        <svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/></svg>
        Library
      </button>
    </div>

    <div class="chat-section">
      <div class="chat-messages" id="chatMessages">
        <div class="chat-msg ai">
          <div class="msg-sender">Partner</div>
          <div class="msg-bubble">I've been reading through your Chapter 3 notes. Kahneman is building toward a profound insight about <em>cognitive ease</em> — the feeling when thinking flows without friction. Want to explore how this connects to your earlier observations?</div>
        </div>
        <div class="chat-msg user">
          <div class="msg-sender">You</div>
          <div class="msg-bubble">Yes, tell me more about cognitive ease</div>
        </div>
        <div class="chat-msg ai">
          <div class="msg-sender">Partner</div>
          <div class="msg-bubble">Cognitive ease is Kahneman's term for the subjective experience of <em>fluent processing</em> — and here's what's disturbing: that fluency gets mis-registered as truth. Your note about "things feeling true when familiar" is exactly this.<br><br>Familiarity and truth become indistinguishable to System 1. This is why repetition creates belief — not evidence, not argument. Just <em>repetition</em>. The propaganda implications are enormous.</div>
        </div>
      </div>

      <div class="chat-input-row">
        <textarea class="chat-input" id="chatInput" placeholder="Ask about your notes, push an idea further..." rows="1" onkeydown="onChatKey(event)" oninput="autoResize(this)"></textarea>
        <button class="send-btn" onclick="sendMsg()">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
        </button>
      </div>
    </div>

    <!-- Blog Panel -->
    <div class="blog-panel">
      <div class="blog-panel-header">
        <div class="blog-panel-title">Blog Discoveries</div>
        <div class="blog-searching" id="blogSearching">
          <div class="s-dot"></div><div class="s-dot"></div><div class="s-dot"></div>
          <span style="font-size:10px;color:var(--text-4)">Searching...</span>
        </div>
      </div>
      <div class="blog-list" id="blogList">
        <div class="blog-card">
          <div class="blog-favicon">FS</div>
          <div class="blog-info">
            <div class="blog-card-title">Why Your Brain Takes Shortcuts: The Science Behind Cognitive Bias</div>
            <div class="blog-domain">fs.blog</div>
          </div>
          <button class="blog-read">Read</button>
        </div>
        <div class="blog-card" style="animation-delay:.05s">
          <div class="blog-favicon">LW</div>
          <div class="blog-info">
            <div class="blog-card-title">Dual Process Theory: How System 1 and 2 Shape Every Decision You Make</div>
            <div class="blog-domain">lesswrong.com</div>
          </div>
          <button class="blog-read">Read</button>
        </div>
        <div class="blog-card" style="animation-delay:.1s">
          <div class="blog-favicon">MD</div>
          <div class="blog-info">
            <div class="blog-card-title">WYSIATI: The Mental Model That Explains Why We're So Often Wrong</div>
            <div class="blog-domain">medium.com</div>
          </div>
          <button class="blog-read">Read</button>
        </div>
      </div>
    </div>
  </aside>

</div><!-- /app -->

<!-- Add Book Modal -->
<div class="modal-overlay" id="modalOverlay" onclick="outsideClose(event)">
  <div class="modal">
    <div class="modal-title">Add to Your Library</div>
    <div class="modal-sub">What are you reading?</div>
    <div class="form-group">
      <label class="form-label">Book Title</label>
      <input class="form-input" id="newTitle" type="text" placeholder="e.g. The Pragmatic Programmer">
    </div>
    <div class="form-group">
      <label class="form-label">Author</label>
      <input class="form-input" id="newAuthor" type="text" placeholder="e.g. David Thomas, Andy Hunt">
    </div>
    <div class="form-group">
      <label class="form-label">Category</label>
      <input class="form-input" id="newCat" type="text" placeholder="e.g. Philosophy, Business, Science">
    </div>
    <div class="form-group">
      <label class="form-label">Why are you reading this?</label>
      <textarea class="form-ta" id="newWhy" placeholder="What drew you to this book? What do you hope to discover in it?"></textarea>
    </div>
    <div class="modal-actions">
      <button class="btn-ghost" onclick="closeModal()">Cancel</button>
      <button class="btn-amber" style="flex:0;padding:9px 20px" onclick="addBook()">Add Book</button>
    </div>
  </div>
</div>

<!-- Tweet Modal -->
<div class="modal-overlay" id="tweetModalOverlay" onclick="outsideTweetClose(event)">
  <div class="modal" style="width:520px">
    <div class="modal-title">Tweet These Ideas</div>
    <div class="modal-sub" id="tweetModalSub">Generating tweet-ready insights from your notes…</div>
    <div id="tweetList" class="tweet-list"></div>
    <div class="modal-actions">
      <button class="btn-ghost" onclick="closeTweetModal()">Close</button>
    </div>
  </div>
</div>

<!-- Thread Modal -->
<div class="modal-overlay" id="threadModalOverlay" onclick="outsideThreadClose(event)">
  <div class="modal thread-modal">
    <div class="thread-modal-header">
      <div>
        <div class="modal-title">Twitter Thread</div>
        <div class="modal-sub" id="threadModalSub">Weaving your thread…</div>
      </div>
      <button class="thread-copy-all" id="threadCopyAll" onclick="copyWholeThread()" style="display:none">
        <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>
        Copy All
      </button>
    </div>
    <div id="threadList" class="thread-list"></div>
    <div class="modal-actions">
      <button class="btn-ghost" onclick="closeThreadModal()">Close</button>
    </div>
  </div>
</div>

<!-- Toast notification -->
<div class="toast" id="toast"></div>

<script>
// ═══════════════════════════════════════
// DATA
// ═══════════════════════════════════════
const BOOKS = [
  { id: 'tfs', title: 'Thinking, Fast and Slow', author: 'Daniel Kahneman', spine: '#1e3a6e', progress: 62 },
  { id: 'aow', title: 'The Art of War',          author: 'Sun Tzu',           spine: '#6e1e1e', progress: 100 },
  { id: 'ah',  title: 'Atomic Habits',           author: 'James Clear',       spine: '#1e4a2e', progress: 35  }
];

let selectedBook    = 'tfs';
let activeTab       = 'notes';
let responseIdx     = 0;
let libraryMode     = false;
let chapterNotes    = {};    // { bookId: { chapterName: content } }
let currentChapterId = null; // name of the active chapter
let _saveTimer      = null;  // debounce handle for backend auto-save
let _currentFlow    = null;  // last rendered flow data (for SVG resize)
let _nodeRegistry   = {};    // nodeId → DOM element for the current diagram

const AI_RESPONSES = [
  "That's a rich angle. Your notes are already gesturing toward what Kahneman calls the <em>narrative fallacy</em> — the tendency to build a coherent story from whatever fragments we have, then mistake that story for the truth. The coherence is the danger.",
  "Think about the implication for your own reading. When a chapter clicks — when it feels like you really understood it — that's cognitive ease talking. The real question Kahneman would ask: what are you NOT seeing right now? What is your WYSIATI?",
  "There's a beautiful paradox here worth exploring: the act of writing notes forces System 2 online. By externalizing thoughts, you're offloading working memory, which actually lets System 2 operate on bigger ideas. Feynman knew this. Darwin kept meticulous notebooks for exactly this reason.",
  "Kahneman's anchoring research points to something uncomfortable: knowing about a bias does not protect you from it. You can know anchoring exists, accept the dice roll was random, and still be influenced. This is why institutional design matters more than individual willpower.",
  "The connection you're sensing is real. Cognitive ease, familiarity, fluency, and the feeling of truth are all the same underlying signal. Your brain uses <em>ease of processing</em> as a proxy for validity — an elegant heuristic that works most of the time and fails catastrophically in exactly the situations that matter most.",
  "Here's a synthesis worth capturing: Systems 1 and 2 aren't adversaries — they're collaborators with a flawed division of labor. System 1 is supposed to handle the routine; System 2 handles the novel. The problem is System 1 doesn't always know when something is genuinely novel. It treats the unfamiliar as familiar and moves on."
];

// ═══════════════════════════════════════
// PROTOTYPE CONTENT (per-book, no backend)
// ═══════════════════════════════════════
const PROTO_CONTENT = {
  tfs: {
    chapters: [
      { name: 'Chapter 1 — Two Systems', wordCount: 64, content: 'The book opens by establishing that human cognition is dual-layered. System 1 operates automatically — it reads emotions, recognizes faces, understands sentences without effort. System 2 is deliberate and expensive. The key insight: System 2 doesn\'t supervise System 1 continuously. It mostly accepts what System 1 presents.' },
      { name: 'Chapter 2 — Attention and Effort', wordCount: 51, content: 'Pupils dilate visibly during hard mental work — cognitive effort is literally physical. The battery metaphor: System 2 drains a finite resource. This is why important decisions made late in the day are worse. Ego depletion is real. Glucose restores deliberate thinking capacity. The implications for scheduling and decision-making are enormous.' },
      { name: 'Chapter 3 — The Lazy Controller', wordCount: 48, content: 'We are cognitive misers by design. The bat and ball problem: $1.10 total, bat costs $1 more than the ball. Most say 10 cents. It\'s 5 cents. The intuitive answer feels fluent — and that fluency signals correctness to System 1. System 2 doesn\'t check unless prompted. This is WYSIATI in action.' },
      { name: 'Chapter 4 — The Associative Machine', wordCount: 0, content: '' }
    ],
    activeChapter: 'Chapter 3 — The Lazy Controller',
    activeNotes: 'Kahneman opens with something brilliant — there are two ways we think. One is fast, automatic, like recognizing a face or reading anger in someone\'s voice. The other is slow, deliberate, like solving 17×24. The fast one (System 1) runs without us noticing. It\'s always on. The slow one (System 2) is lazy — it only engages when needed. Key: System 1 is constantly generating impressions and jumping to conclusions. System 2 mostly just endorses these without scrutiny. This is simultaneously terrifying and fascinating. The gorilla experiment. We don\'t see what we\'re not looking for.',
    ideas: [
      { title: 'System 1 vs System 2 Thinking', body: 'Human cognition runs on two parallel tracks. System 1 is automatic, instant, and constantly running — shaping almost every moment-to-moment perception. System 2 is deliberate and effortful, but dangerously passive: it tends to endorse whatever System 1 serves up, rarely questioning the source.', tags: ['DUAL PROCESS', 'AUTOMATICITY'] },
      { title: 'The WYSIATI Principle', body: 'What You See Is All There Is. System 1 constructs the most coherent narrative possible from available data — without ever noting what information is absent. This is why snap judgments feel complete and confident even when built on a fraction of what\'s relevant.', tags: ['NARRATIVE BIAS', 'OVERCONFIDENCE'] },
      { title: 'Anchoring Effect in Decision Making', body: 'The first number encountered in any estimation contaminates all subsequent judgments — even when you know it\'s arbitrary. Kahneman showed that judges assigned shorter sentences after rolling low dice numbers. The anchor operates below the threshold of conscious awareness, making it nearly impossible to correct for.', tags: ['ANCHORING', 'PRIMING', 'HEURISTICS'] },
      { title: 'Cognitive Ease & the Illusion of Truth', body: 'When information is easy to process, we experience it as familiar, true, and credible. This is cognitive ease — and it\'s weaponizable. Repetition doesn\'t create truth, but it creates the feeling of truth. This is why propaganda relies on repetition, not argument. Fluency masquerades as validity.', tags: ['COGNITIVE EASE', 'FLUENCY', 'TRUTH PERCEPTION'] }
    ]
  },
  aow: {
    chapters: [
      { name: 'The Plans', wordCount: 57, content: 'Sun Tzu opens with a foundational claim: war is of vital importance to the state — a matter of life and death. Before any battle begins, the outcome is largely decided. Victory goes to the side that calculated most carefully: which commander has more ability, which army is better trained, which side has heaven (weather, timing) and earth (terrain) on its side.' },
      { name: 'On Waging War', wordCount: 49, content: 'Prolonged warfare exhausts the state. The clever general feeds his troops on the enemy\'s supplies. Sun Tzu\'s economics of war: it costs ten times more to bring supplies from home than to seize them locally. Speed matters not just tactically but financially. A swift, decisive victory is cheaper than a protracted "successful" campaign.' },
      { name: 'Attack by Stratagem', wordCount: 44, content: 'The supreme art of war is to subdue the enemy without fighting. Capturing intact is preferred over destroying. Breaking resistance without battle is the pinnacle of excellence. Know yourself and know your enemy — a hundred battles, a hundred victories. But supreme excellence is breaking the enemy\'s resistance without fighting at all.' }
    ],
    activeChapter: 'The Plans',
    activeNotes: 'Sun Tzu\'s genius is that this isn\'t really a book about war — it\'s a book about strategy in any competitive domain. Every principle translates. All warfare is deception: if you can do something, feign you cannot. If you are near, make the enemy think you are far. The supreme commander wins before the battle starts — through superior preparation, intelligence, and positioning. The actual clash is almost an afterthought. Victory is decided in planning, not fighting.',
    ideas: [
      { title: 'All Warfare is Deception', body: 'The foundational principle of Sun Tzu: appear where you are not, attack where they don\'t expect. Every tactical move contains a psychological dimension. The goal isn\'t just to outmanoeuvre physically, but to corrupt the enemy\'s model of reality. A general who masters deception wins before the first blow is struck.', tags: ['STRATEGY', 'DECEPTION', 'PSYCHOLOGY'] },
      { title: 'Win Without Fighting', body: 'The supreme art of war is to subdue the enemy without fighting. Destroying an enemy army is second-rate strategy — capturing it intact is supreme. This demands patience, intelligence, and positioning over aggression. The greatest victories are bloodless: they happen in the minds of adversaries before any engagement begins.', tags: ['LEVERAGE', 'POSITIONING', 'VICTORY'] },
      { title: 'Know Yourself, Know the Enemy', body: 'If you know the enemy and know yourself, you need not fear the result of a hundred battles. If you know yourself but not the enemy, for every victory gained you will also suffer a defeat. The locus of intelligence is self-knowledge as much as enemy intelligence — most failures come from overconfidence in one\'s own position.', tags: ['INTELLIGENCE', 'SELF-AWARENESS', 'RISK'] }
    ]
  },
  ah: {
    chapters: [
      { name: 'The Fundamentals', wordCount: 61, content: 'The surprising power of tiny habits: a 1% improvement each day compounds to 37x better over a year. But 1% worse daily compounds to near zero. Habits are the compound interest of self-improvement. Most people focus on goals; Clear argues this is backwards. Goals are about the results you want. Systems are about the processes that lead to those results. You don\'t rise to the level of your goals — you fall to the level of your systems.' },
      { name: 'The 1st Law — Make It Obvious', wordCount: 53, content: 'Implementation intentions: "I will [BEHAVIOR] at [TIME] in [LOCATION]." Research shows this doubles follow-through rates. Habit stacking: "After I [CURRENT HABIT], I will [NEW HABIT]." The environment is the invisible hand shaping behavior. Design your environment so good habits are obvious. Put the guitar on the stand, not in the case. Leave the book on the pillow, not on the shelf.' },
      { name: 'Identity-Based Habits', wordCount: 47, content: 'Every action is a vote for the type of person you want to become. The goal isn\'t to read a book, it\'s to become a reader. Not to run a marathon, but to become a runner. Identity change is the north star of habit change. The most effective way to change is not to focus on what you want to achieve, but on who you want to become.' }
    ],
    activeChapter: 'The Fundamentals',
    activeNotes: 'Clear\'s central insight: we don\'t have a motivation problem, we have a system design problem. Every habit exists because it\'s solving a problem — providing a reward, reducing friction, satisfying a craving. The four laws of behavior change (Cue, Craving, Response, Reward) aren\'t separate steps, they\'re a continuous loop. And crucially: habits encode the path of least resistance. Whatever is easiest is what gets done. Design the environment to make virtue the easy choice.',
    ideas: [
      { title: 'Identity is the Lever of Lasting Change', body: 'Most people try to change outcomes (lose weight) rather than identity (become someone who moves daily). But identity changes cascade into behavior changes automatically. Each small habit is a vote cast for a new self-image. The question isn\'t "Can I do this?" but "Is this the kind of person I am?"', tags: ['IDENTITY', 'BEHAVIOR', 'SELF-IMAGE'] },
      { title: 'The 1% Rule: Compounding Behavior', body: 'Getting 1% better each day for a year means ending up 37 times better. Getting 1% worse compounds to near zero. Habits are the compound interest of self-improvement — invisible in the short term, transformative over time. This is why patience is not passive: it\'s the strategic exploitation of compounding.', tags: ['COMPOUNDING', 'MARGINAL GAINS', 'SYSTEMS'] },
      { title: 'Environment Over Willpower', body: 'Willpower is not a reliable resource — it depletes. The professionals don\'t rely on motivation; they engineer their environment so that the right behavior is the default behavior. Put the fruit on the counter, remove the junk from the house. Friction is the hidden controller of all action — reduce it for good habits, increase it for bad ones.', tags: ['ENVIRONMENT DESIGN', 'FRICTION', 'DEFAULTS'] }
    ]
  }
};

// ═══════════════════════════════════════
// PROTOTYPE FLOW DATA (Connections tab)
// ═══════════════════════════════════════
const PROTO_FLOW = {
  books: [
    { id: 'tfs', title: 'Thinking, Fast and Slow', author: 'Daniel Kahneman', spine: '#1e3a6e' },
    { id: 'aow', title: 'The Art of War',           author: 'Sun Tzu',         spine: '#6e1e1e' },
    { id: 'ah',  title: 'Atomic Habits',            author: 'James Clear',     spine: '#1e4a2e' }
  ],
  themes: [
    { id: 't0', name: 'Architecture of Decision', color: '#c9a84c' },
    { id: 't1', name: 'Identity as Leverage',     color: '#9b8ed4' },
    { id: 't2', name: 'Systems Over Willpower',   color: '#5aac8a' },
    { id: 't3', name: 'Truth & Narrative',        color: '#d4836e' }
  ],
  ideas: [
    { id: 'i0', bookId: 'tfs', themeId: 't0', title: 'Anchoring Effect',       body: 'The first number encountered shapes all subsequent estimates — even when arbitrary.' },
    { id: 'i1', bookId: 'aow', themeId: 't0', title: 'Win Before You Fight',   body: 'Victory is decided in planning and positioning, not in the clash itself.' },
    { id: 'i2', bookId: 'ah',  themeId: 't1', title: 'Identity is the Lever',  body: 'Each small habit casts a vote for the type of person you are becoming.' },
    { id: 'i3', bookId: 'aow', themeId: 't1', title: 'Know Yourself First',    body: 'Self-knowledge precedes all strategic clarity and decisive action.' },
    { id: 'i4', bookId: 'ah',  themeId: 't2', title: 'Environment Design',     body: 'Friction is the invisible controller of all behaviour — engineer defaults.' },
    { id: 'i5', bookId: 'tfs', themeId: 't2', title: 'Cognitive Ease',         body: 'Fluent processing masquerades as truth; design for clarity, not just content.' },
    { id: 'i6', bookId: 'tfs', themeId: 't3', title: 'WYSIATI',                body: 'System 1 builds a coherent story from fragments and calls it reality.' },
    { id: 'i7', bookId: 'aow', themeId: 't3', title: 'Deception as Strategy',  body: 'Shape the enemy\'s perception of reality before shaping the battlefield.' }
  ]
};

function loadProtoContent(bookId) {
  const proto = PROTO_CONTENT[bookId];
  if (!proto) return;

  // Initialise mutable chapter state from prototype data
  chapterNotes[bookId] = {};
  proto.chapters.forEach(c => { chapterNotes[bookId][c.name] = c.content; });
  // The activeChapter gets the richer textarea version
  chapterNotes[bookId][proto.activeChapter] = proto.activeNotes;

  // Populate chapter dropdown and wire onchange
  const chapterSelect = document.getElementById('chapterSelect');
  chapterSelect.innerHTML = proto.chapters.map(c =>
    `<option value="${c.name}">${c.name}</option>`
  ).join('');
  chapterSelect.onchange = () => switchChapter(chapterSelect.value);

  // Activate the default chapter
  currentChapterId = proto.activeChapter;
  document.getElementById('mainNotes').value = proto.activeNotes;
  chapterSelect.value = proto.activeChapter;
  renderAccordion();

  // ── Ideas tab ──────────────────────────────────────────
  const grid = document.getElementById('ideasGrid');
  grid.innerHTML = proto.ideas.map((idea, i) => `
    <div class="idea-card">
      <div class="idea-num">INSIGHT ${String(i + 1).padStart(2, '0')}</div>
      <div class="idea-title">${idea.title}</div>
      <div class="idea-body">${idea.body}</div>
      <div class="idea-tags">${idea.tags.map(t => `<span class="idea-tag">${t}</span>`).join('')}</div>
      <button class="idea-explore" onclick="exploreIdea('${idea.title.replace(/'/g, "\\'")}')">
        <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M5 12h14m-7-7l7 7-7 7"/></svg>
        Explore Further
      </button>
    </div>
  `).join('');
}

// ═══════════════════════════════════════
// CHAPTER MANAGEMENT
// ═══════════════════════════════════════

function saveCurrentChapter() {
  if (!selectedBook || !currentChapterId) return;
  if (!chapterNotes[selectedBook]) chapterNotes[selectedBook] = {};
  chapterNotes[selectedBook][currentChapterId] = document.getElementById('mainNotes').value;
}

function switchChapter(name) {
  saveCurrentChapter();
  currentChapterId = name;
  const textarea = document.getElementById('mainNotes');
  textarea.value = chapterNotes[selectedBook]?.[name] ?? '';
  document.getElementById('chapterSelect').value = name;
  renderAccordion();
  textarea.focus();
}

function renderAccordion() {
  const chapters = chapterNotes[selectedBook] || {};
  document.querySelector('.accordion').innerHTML = Object.entries(chapters).map(([name, content], i) => {
    const wc = content ? content.trim().split(/\s+/).filter(Boolean).length : 0;
    const safeName = name.replace(/\\/g, '\\\\').replace(/'/g, "\\'");
    return `
      <div class="accordion-item ${name === currentChapterId ? 'open' : ''}" id="acc-book-${i}">
        <div class="accordion-head" onclick="switchChapter('${safeName}')">
          <div>
            <div class="acc-title">${name}</div>
            <div class="acc-meta">${wc} words</div>
          </div>
          <svg class="acc-chevron" width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
        </div>
        <div class="accordion-body">
          <div class="acc-content">${content || '<em style="color:var(--text-4)">No notes yet.</em>'}</div>
        </div>
      </div>`;
  }).join('');
}

function addChapter() {
  if (!selectedBook) return;
  const existing = Object.keys(chapterNotes[selectedBook] || {});
  const defaultName = `Chapter ${existing.length + 1}`;
  const name = window.prompt('New chapter name:', defaultName);
  if (!name || !name.trim()) return;
  const trimmed = name.trim();
  if (chapterNotes[selectedBook]?.[trimmed] !== undefined) {
    showToast('Chapter already exists'); return;
  }
  if (!chapterNotes[selectedBook]) chapterNotes[selectedBook] = {};
  chapterNotes[selectedBook][trimmed] = '';
  const opt = document.createElement('option');
  opt.value = trimmed; opt.textContent = trimmed;
  document.getElementById('chapterSelect').appendChild(opt);
  switchChapter(trimmed);
  showToast(`Added "${trimmed}"`);
  if (CURRENT_BOOK_ID) {
    api('POST', '/notes', { book_id: CURRENT_BOOK_ID, chapter_name: trimmed, content: '' });
  }
}

function onNotesInput() {
  if (!selectedBook || !currentChapterId) return;
  const content = document.getElementById('mainNotes').value;
  if (!chapterNotes[selectedBook]) chapterNotes[selectedBook] = {};
  chapterNotes[selectedBook][currentChapterId] = content;
  // Live-update word count and preview in the accordion
  const wc = content.trim().split(/\s+/).filter(Boolean).length;
  const activeItem = [...document.querySelectorAll('.accordion-item')].find(el =>
    el.querySelector('.acc-title')?.textContent === currentChapterId
  );
  if (activeItem) {
    const meta = activeItem.querySelector('.acc-meta');
    if (meta) meta.textContent = `${wc} words`;
    const preview = activeItem.querySelector('.acc-content');
    if (preview) preview.textContent = content || '';
  }
  // Debounced save to backend (live mode only)
  if (CURRENT_BOOK_ID) {
    clearTimeout(_saveTimer);
    _saveTimer = setTimeout(() => {
      api('POST', '/notes', { book_id: CURRENT_BOOK_ID, chapter_name: currentChapterId, content });
    }, 1500);
  }
}

// ═══════════════════════════════════════
// INIT
// ═══════════════════════════════════════
function init() {
  renderBooks();
  scrollChat();
  // Seed chapter state for the default prototype book so the
  // dropdown and accordion work immediately before any book is clicked
  loadProtoContent(selectedBook);
}

// ═══════════════════════════════════════
// BOOKS
// ═══════════════════════════════════════
function renderBooks() {
  const list = document.getElementById('bookList');
  list.innerHTML = BOOKS.map(b => `
    <div class="book-card ${b.id === selectedBook ? 'active' : ''}" onclick="selectBook('${b.id}')">
      <div class="book-spine" style="background:${b.spine}"></div>
      <div class="book-info">
        <div class="book-title">${b.title}</div>
        <div class="book-author">${b.author}</div>
        <div class="progress-wrap">
          <div class="progress-bar"><div class="progress-fill" style="width:${b.progress}%"></div></div>
          <span class="progress-pct">${b.progress}%</span>
        </div>
      </div>
    </div>
  `).join('');
}

function selectBook(id) {
  CURRENT_BOOK_ID = id;
  selectedBook = id;
  const b = BOOKS.find(x => x.id === id);
  document.getElementById('barTitle').textContent = b.title;
  document.getElementById('barAuthor').textContent = `— ${b.author}`;
  renderBooks();
  showToast(`Switched to "${b.title}"`);

  // Reset conversation history for the new book
  conversationHistory = [];

  // Load this book's notes + ideas from the API
  if (CURRENT_BOOK_ID) loadBookContent(CURRENT_BOOK_ID);
  connectionsLoaded = false; // force graph refresh on next tab visit
}

async function loadBookContent(bookId) {
  // Fetch notes and ideas in parallel
  const [notes, ideas] = await Promise.all([
    api('GET', `/notes?book_id=${bookId}`),
    api('GET', `/distill?book_id=${bookId}`)
  ]);

  // Both null means backend is unreachable — load per-book prototype content
  if (notes === null && ideas === null) {
    loadProtoContent(bookId);
    return;
  }

  // ── Notes tab ──────────────────────────────────────────
  const chapterSelect = document.getElementById('chapterSelect');
  const mainNotes     = document.getElementById('mainNotes');
  const accordion     = document.querySelector('.accordion');

  if (notes !== null && notes.length > 0) {
    // Initialise mutable chapter state from API data
    chapterNotes[bookId] = {};
    notes.forEach(n => { chapterNotes[bookId][n.chapter_name] = n.content || ''; });

    // Populate chapter dropdown and wire onchange
    chapterSelect.innerHTML = notes.map(n =>
      `<option value="${n.chapter_name}">${n.chapter_name}</option>`
    ).join('');
    chapterSelect.onchange = () => switchChapter(chapterSelect.value);

    // Activate first chapter
    switchChapter(notes[0].chapter_name);
  } else if (notes !== null) {
    // Backend responded but no notes yet — seed one blank chapter
    chapterNotes[bookId] = { 'Chapter 1': '' };
    chapterSelect.innerHTML = '<option value="Chapter 1">Chapter 1</option>';
    chapterSelect.onchange = () => switchChapter(chapterSelect.value);
    currentChapterId = 'Chapter 1';
    mainNotes.value = '';
    renderAccordion();
  }

  // ── Ideas tab ──────────────────────────────────────────
  if (ideas !== null) {
    const grid = document.getElementById('ideasGrid');
    grid.innerHTML = '';

    if (ideas.length > 0) {
      ideas.forEach((idea, i) => {
        const card = document.createElement('div');
        card.className = 'idea-card';
        card.style.animationDelay = `${i * 0.07}s`;
        card.innerHTML = `
          <div class="idea-num">INSIGHT ${String(idea.number || i + 1).padStart(2, '0')}</div>
          <div class="idea-title">${idea.title}</div>
          <div class="idea-body">${idea.body}</div>
          <div class="idea-tags">${(idea.tags || []).map(t => `<span class="idea-tag">${t}</span>`).join('')}</div>
          <button class="idea-explore" onclick="exploreIdea('${idea.title.replace(/'/g, "\\'")}')">
            <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M5 12h14m-7-7l7 7-7 7"/></svg>
            Explore Further
          </button>
        `;
        grid.appendChild(card);
      });
    } else {
      grid.innerHTML = `<div style="padding:24px 0;font-size:12.5px;color:var(--text-4);grid-column:1/-1">No ideas yet — write some notes and hit Distill Ideas.</div>`;
    }
  }

  // ── Blog panel ─────────────────────────────────────────
  document.getElementById('blogList').innerHTML = '';
}

// ═══════════════════════════════════════
// SIDEBAR
// ═══════════════════════════════════════
function toggleSidebar() {
  document.getElementById('sidebar').classList.toggle('collapsed');
}

// ═══════════════════════════════════════
// TABS
// ═══════════════════════════════════════
let connectionsLoaded = false;
function switchTab(tab) {
  document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  document.getElementById(`pane-${tab}`).classList.add('active');
  document.getElementById(`tab${tab.charAt(0).toUpperCase() + tab.slice(1)}`).classList.add('active');
  activeTab = tab;
  if (tab === 'connections' && !connectionsLoaded) {
    connectionsLoaded = true;
    loadCrossBookIdeas();
  }
}

// ═══════════════════════════════════════
// ACCORDION
// ═══════════════════════════════════════
function toggleAcc(id) {
  document.getElementById(`acc-${id}`).classList.toggle('open');
}

// ═══════════════════════════════════════
// DISTILL IDEAS
// ═══════════════════════════════════════
function distillIdeas() {
  const btn = document.getElementById('distillBtn');
  if (btn.classList.contains('loading')) return;
  btn.classList.add('loading');
  btn.innerHTML = `
    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="animation:spin 1s linear infinite">
      <path d="M21 12a9 9 0 1 1-6.219-8.56"/>
    </svg>
    Distilling...
  `;

  const chapterName = document.getElementById('chapterSelect').value;
  const rawNotes    = document.getElementById('mainNotes').value;

  // Try real API first
  const doDistil = async () => {
    if (CURRENT_BOOK_ID) {
      const result = await distillIdeasFromAPI(CURRENT_BOOK_ID, chapterName, rawNotes);
      if (result?.ideas?.length) {
        renderIdeasFromAPI(result.ideas);
      }
    }
    btn.classList.remove('loading');
    btn.innerHTML = `
      <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M9 3H5a2 2 0 0 0-2 2v4m6-6h10a2 2 0 0 1 2 2v4M9 3v18m0 0h10a2 2 0 0 0 2-2V9M9 21H5a2 2 0 0 1-2-2V9m0 0h18"/>
      </svg>
      Distill Ideas
    `;
    switchTab('ideas');
    setTimeout(() => {
      addAI("I've crystallized your notes into core insights. The thread running through all of them: <em>the gap between what we believe we're doing cognitively and what we're actually doing</em>. Want to start with WYSIATI? It's the gravitational centre of the book.");
    }, 400);
  };

  setTimeout(doDistil, 2400);
}

// ═══════════════════════════════════════
// RENDER REAL IDEA CARDS
// ═══════════════════════════════════════
function renderIdeasFromAPI(ideas) {
  const grid = document.getElementById('ideasGrid');
  // Append new cards rather than replacing (prototype cards stay)
  ideas.forEach((idea, i) => {
    const card = document.createElement('div');
    card.className = 'idea-card';
    card.style.animationDelay = `${i * 0.07}s`;
    card.innerHTML = `
      <div class="idea-num">INSIGHT ${String(idea.number || i + 1).padStart(2, '0')}</div>
      <div class="idea-title">${idea.title}</div>
      <div class="idea-body">${idea.body}</div>
      <div class="idea-tags">${(idea.tags || []).map(t => `<span class="idea-tag">${t}</span>`).join('')}</div>
      <button class="idea-explore" onclick="exploreIdea('${idea.title.replace(/'/g, "\\'")}')">
        <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M5 12h14m-7-7l7 7-7 7"/></svg>
        Explore Further
      </button>
    `;
    grid.appendChild(card);
  });
}

// ═══════════════════════════════════════
// FIND BLOG ARTICLES
// ═══════════════════════════════════════
function findBlogArticles() {
  const searching = document.getElementById('blogSearching');
  const list = document.getElementById('blogList');
  searching.classList.add('on');
  list.style.opacity = '.35';
  list.style.pointerEvents = 'none';

  const doSearch = async () => {
    let articles = null;

    if (CURRENT_BOOK_ID) {
      articles = await searchArticlesFromAPI(CURRENT_BOOK_ID, null);
    }

    searching.classList.remove('on');
    list.style.opacity = '1';
    list.style.pointerEvents = '';

    if (articles && articles.length) {
      // Replace prototype cards with real results
      list.innerHTML = '';
      articles.forEach((a, i) => {
        const initials = a.domain.split('.')[0].slice(0, 2).toUpperCase();
        const card = document.createElement('div');
        card.className = 'blog-card';
        card.style.animationDelay = `${i * 0.05}s`;
        if (i === 0) card.style.borderColor = 'var(--amber-dk)';
        const stanceBadge = a.stance && a.stance !== 'neutral'
          ? `<span class="stance-badge ${a.stance}">${a.stance}</span>`
          : (a.stance === 'neutral' ? `<span class="stance-badge neutral">neutral</span>` : '');
        card.innerHTML = `
          <div class="blog-favicon">${initials}</div>
          <div class="blog-info">
            <div class="blog-card-title">${a.title}</div>
            <div class="blog-domain">${a.domain}</div>
            ${stanceBadge}
          </div>
          <button class="blog-read" onclick="window.open('${a.url}','_blank')">${i === 0 ? 'New' : 'Read'}</button>
        `;
        list.appendChild(card);
      });
      addAI(`Found ${articles.length} relevant articles. The top result from ${articles[0]?.domain} looks particularly strong — want me to pull out the key ideas so you can cross-reference with your notes?`);
    } else {
      // Prototype fallback
      const card = document.createElement('div');
      card.className = 'blog-card';
      card.style.borderColor = 'var(--amber-dk)';
      card.innerHTML = `
        <div class="blog-favicon" style="background:var(--amber-glow);color:var(--amber-dk)">HB</div>
        <div class="blog-info">
          <div class="blog-card-title">Kahneman's System 1 & 2: The Neuroscience Behind Why We Think What We Think</div>
          <div class="blog-domain">hubermanlab.com</div>
        </div>
        <button class="blog-read" style="border-color:var(--amber-dk);color:var(--amber)">New</button>
      `;
      list.insertBefore(card, list.firstChild);
      setTimeout(() => {
        addAI("Found 4 relevant articles. The Farnam Street piece is particularly strong — it builds a direct bridge between cognitive ease and the mental models framework. Highly relevant to your Chapter 3 notes.");
      }, 500);
    }
  };

  setTimeout(doSearch, 1900);
}

// ═══════════════════════════════════════
// TWEET MODAL
// ═══════════════════════════════════════
function openTweetModal() {
  const notes = document.getElementById('mainNotes').value.trim();
  if (!notes) { showToast('Write some notes first'); return; }

  const overlay = document.getElementById('tweetModalOverlay');
  const list    = document.getElementById('tweetList');
  const sub     = document.getElementById('tweetModalSub');

  list.innerHTML = '<div class="tweet-loading"><div class="tweet-spinner"></div>Generating tweet-ready insights…</div>';
  sub.textContent = 'Generating tweet-ready insights from your notes…';
  overlay.classList.add('open');

  const doGenerate = async () => {
    let tweets = null;

    if (CURRENT_BOOK_ID) {
      const chapterName = document.getElementById('chapterSelect').value;
      const result = await api('POST', '/tweets', {
        book_id:      CURRENT_BOOK_ID,
        chapter_name: chapterName,
        content:      notes
      });
      tweets = result?.tweets || null;
    }

    if (!tweets) {
      // Prototype fallback
      tweets = [
        `Most people think slow thinking is safe. Kahneman shows the opposite: System 2 is lazy, not careful. It mostly endorses whatever System 1 hands it without scrutiny.`,
        `The bat-and-ball problem isn't a trick — it's a window into how you think. If your gut said 10 cents, System 1 handed you a fluent lie and System 2 signed off without checking.`,
        `WYSIATI: What You See Is All There Is. Your brain builds the most coherent story it can from whatever's in front of it — and never notices what's missing.`
      ];
    }

    sub.textContent = `${tweets.length} tweet${tweets.length !== 1 ? 's' : ''} ready to copy`;
    list.innerHTML = tweets.map((t, i) => {
      const len  = t.length;
      const warn = len > 260 ? ' warn' : '';
      return `
        <div class="tweet-item">
          <div>${escHtml(t)}</div>
          <div class="tweet-footer">
            <span class="tweet-char${warn}">${len}/280</span>
            <button class="tweet-copy" onclick="copyTweet(this, ${i})">Copy</button>
          </div>
        </div>`;
    }).join('');

    // Store tweets on the list for copying
    list._tweets = tweets;
  };

  doGenerate();
}

function copyTweet(btn, idx) {
  const list   = document.getElementById('tweetList');
  const tweets = list._tweets || [];
  const text   = tweets[idx];
  if (!text) return;
  navigator.clipboard.writeText(text).then(() => {
    btn.textContent = 'Copied!';
    btn.classList.add('copied');
    setTimeout(() => { btn.textContent = 'Copy'; btn.classList.remove('copied'); }, 2000);
  });
}

function closeTweetModal() {
  document.getElementById('tweetModalOverlay').classList.remove('open');
}

function outsideTweetClose(e) {
  if (e.target === document.getElementById('tweetModalOverlay')) closeTweetModal();
}

function escHtml(str) {
  return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

// ═══════════════════════════════════════
// THREAD MODAL
// ═══════════════════════════════════════
function openThreadModal() {
  const notes = document.getElementById('mainNotes').value.trim();
  if (!notes) { showToast('Write some notes first'); return; }

  const overlay = document.getElementById('threadModalOverlay');
  const list    = document.getElementById('threadList');
  const sub     = document.getElementById('threadModalSub');
  const copyAll = document.getElementById('threadCopyAll');

  list.innerHTML = '<div class="tweet-loading"><div class="tweet-spinner"></div>Weaving your thread…</div>';
  sub.textContent = 'Weaving your thread…';
  copyAll.style.display = 'none';
  overlay.classList.add('open');

  const doGenerate = async () => {
    let thread = null;

    if (CURRENT_BOOK_ID) {
      const chapterName = document.getElementById('chapterSelect').value;
      const result = await api('POST', '/tweets/thread', {
        book_id:      CURRENT_BOOK_ID,
        chapter_name: chapterName,
        content:      notes
      });
      thread = result?.thread || null;
    }

    // Prototype fallback
    if (!thread) {
      thread = [
        { number: 1, text: "Kahneman discovered we have two minds running simultaneously. System 1 is fast, automatic, never off. System 2 is slow and deliberate — and here's the uncomfortable part — almost always asleep on the job." },
        { number: 2, text: "System 2 thinks it's in charge. It isn't. System 1 runs the show and hands System 2 a polished conclusion. System 2 signs off without reading the fine print. This happens thousands of times a day, invisibly." },
        { number: 3, text: "The bat-and-ball problem exposes this perfectly. 80% of people say '10 cents.' The answer is 5 cents. It costs nothing to check — System 1 just serves up '10 cents' with total confidence, and System 2 accepts it." },
        { number: 4, text: "Why? WYSIATI — What You See Is All There Is. System 1 builds the most coherent story from available data. It never notes what's absent. The coherence of the story becomes its own evidence of truth." },
        { number: 5, text: "Cognitive ease amplifies this. When information is easy to process, it feels familiar. When it feels familiar, it feels true. Repetition doesn't create truth — it creates the feeling of truth. That's the entire architecture of propaganda." },
        { number: 6, text: "Knowing this doesn't protect you. Kahneman himself — after 40 years studying these biases — still falls for them. The machinery runs below the level where awareness operates. The answer isn't vigilance. It's system design." }
      ];
    }

    sub.textContent = `${thread.length} tweets · read in sequence`;
    copyAll.style.display = '';

    list.innerHTML = thread.map((t, i) => {
      const isHook    = i === 0;
      const isLanding = i === thread.length - 1;
      const avatarCls = isHook ? 'hook' : isLanding ? 'landing' : '';
      const label     = isHook ? '<div class="thread-label">Hook</div>'
                      : isLanding ? '<div class="thread-label land">Landing</div>'
                      : '';
      const text = t.text || '';
      const len  = text.length;
      const warn = len > 260 ? ' warn' : '';

      return `
        <div class="thread-item">
          <div class="thread-spine">
            <div class="thread-avatar ${avatarCls}">${t.number || i + 1}</div>
          </div>
          <div class="thread-body">
            ${label}
            <div class="thread-text">${escHtml(text)}</div>
            <div class="thread-meta">
              <span class="thread-char${warn}">${len}/280</span>
              <button class="tweet-copy" onclick="copyThreadTweet(this, ${i})">Copy</button>
            </div>
          </div>
        </div>`;
    }).join('');

    list._thread = thread;
  };

  doGenerate();
}

function copyThreadTweet(btn, idx) {
  const thread = document.getElementById('threadList')._thread || [];
  const t      = thread[idx];
  if (!t) return;
  const text = `${t.number}/ ${t.text}`;
  navigator.clipboard.writeText(text).then(() => {
    btn.textContent = 'Copied!';
    btn.classList.add('copied');
    setTimeout(() => { btn.textContent = 'Copy'; btn.classList.remove('copied'); }, 2000);
  });
}

function copyWholeThread() {
  const thread = document.getElementById('threadList')._thread || [];
  const text   = thread.map(t => `${t.number}/ ${t.text}`).join('\n\n');
  const btn    = document.getElementById('threadCopyAll');
  navigator.clipboard.writeText(text).then(() => {
    btn.textContent = 'Copied!';
    btn.classList.add('copied');
    setTimeout(() => { btn.innerHTML = `<svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg> Copy All`; btn.classList.remove('copied'); }, 2200);
  });
}

function closeThreadModal() {
  document.getElementById('threadModalOverlay').classList.remove('open');
}

function outsideThreadClose(e) {
  if (e.target === document.getElementById('threadModalOverlay')) closeThreadModal();
}

// ═══════════════════════════════════════
// IDEA EXPLORE
// ═══════════════════════════════════════
function exploreIdea(concept) {
  addAI(`Let's go deep on <em>${concept}</em>. What's the connection you're trying to make? I can pull threads from your other notes, or we can stress-test the idea against what you've read so far.`);
}

// ═══════════════════════════════════════
// THEME PILLS
// ═══════════════════════════════════════
function togglePill(el) {
  el.classList.toggle('active');
}

// ═══════════════════════════════════════
// CHAT
// ═══════════════════════════════════════
function onChatKey(e) {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    sendMsg();
  }
}

function autoResize(el) {
  el.style.height = 'auto';
  el.style.height = Math.min(el.scrollHeight, 110) + 'px';
}

function sendMsg() {
  const input = document.getElementById('chatInput');
  const text = input.value.trim();
  if (!text) return;

  addMsg('user', 'You', text);
  input.value = '';
  input.style.height = 'auto';

  // Typing indicator
  const chat = document.getElementById('chatMessages');
  const ind = document.createElement('div');
  ind.className = 'typing-ind';
  ind.id = 'typingInd';
  ind.innerHTML = '<div class="t-dot"></div><div class="t-dot"></div><div class="t-dot"></div>';
  chat.appendChild(ind);
  scrollChat();

  const delay = 1200 + Math.random() * 900;
  setTimeout(() => {
    ind.remove();
    const resp = AI_RESPONSES[responseIdx % AI_RESPONSES.length];
    responseIdx++;
    addAI(resp);
  }, delay);
}

function addMsg(type, sender, text) {
  const chat = document.getElementById('chatMessages');
  const div = document.createElement('div');
  div.className = `chat-msg ${type}`;
  div.innerHTML = `
    <div class="msg-sender">${sender}</div>
    <div class="msg-bubble">${text}</div>
  `;
  chat.appendChild(div);
  scrollChat();
}

function addAI(html) {
  const chat = document.getElementById('chatMessages');
  const div = document.createElement('div');
  div.className = 'chat-msg ai';
  const bubble = document.createElement('div');
  bubble.className = 'msg-bubble';
  div.innerHTML = '<div class="msg-sender">Partner</div>';
  div.appendChild(bubble);
  chat.appendChild(div);
  scrollChat();
  typeWords(bubble, html, 28);
}

function typeWords(el, html, interval) {
  const words = html.split(' ');
  let i = 0;
  el.innerHTML = '';

  const tick = setInterval(() => {
    if (i >= words.length) {
      clearInterval(tick);
      el.innerHTML = html; // Restore full HTML with tags
      scrollChat();
      return;
    }
    // Show plain text during typing
    const plain = html.replace(/<[^>]*>/g, '');
    const plainWords = plain.split(' ');
    el.textContent = plainWords.slice(0, i + 1).join(' ') + (i < words.length - 1 ? '…' : '');
    i += 1 + (i % 3 === 0 ? 1 : 0); // Slightly variable speed
    scrollChat();
  }, interval);
}

function scrollChat() {
  const chat = document.getElementById('chatMessages');
  requestAnimationFrame(() => { chat.scrollTop = chat.scrollHeight; });
}

// ═══════════════════════════════════════
// MODAL
// ═══════════════════════════════════════
function openModal() {
  document.getElementById('modalOverlay').classList.add('open');
  setTimeout(() => document.getElementById('newTitle').focus(), 280);
}

function closeModal() {
  document.getElementById('modalOverlay').classList.remove('open');
}

function outsideClose(e) {
  if (e.target === document.getElementById('modalOverlay')) closeModal();
}

async function addBook() {
  const title  = document.getElementById('newTitle').value.trim();
  const author = document.getElementById('newAuthor').value.trim();
  const cat    = document.getElementById('newCat').value.trim();
  const why    = document.getElementById('newWhy').value.trim();
  if (!title) { document.getElementById('newTitle').focus(); return; }

  const colors = ['#2a3f6e','#6e2a2a','#2a5e3a','#4a2a6e','#6e4a2a','#2a5e5e','#2a5e8e'];
  const spine  = colors[BOOKS.length % colors.length];

  // Optimistic UI update
  const tempId = 'temp-' + Date.now();
  BOOKS.push({ id: tempId, title, author: author || 'Unknown Author', spine, progress: 0 });
  renderBooks();
  closeModal();
  ['newTitle','newAuthor','newCat','newWhy'].forEach(fid => document.getElementById(fid).value = '');
  showToast(`"${title}" added to your library`);

  // Persist to Supabase in background
  const saved = await addBookToAPI(title, author, cat, why);
  if (saved?.id) {
    const idx = BOOKS.findIndex(b => b.id === tempId);
    if (idx > -1) BOOKS[idx].id = saved.id;
    if (!CURRENT_BOOK_ID) CURRENT_BOOK_ID = saved.id;
  }
}

// ═══════════════════════════════════════
// WRITE TOOLBAR
// ═══════════════════════════════════════
function execFmt(cmd) {
  const area = document.getElementById('writeArea');
  area.focus();
  if (cmd === 'heading') {
    document.execCommand('formatBlock', false, 'h2');
  } else if (cmd === 'blockquote') {
    document.execCommand('formatBlock', false, 'blockquote');
  } else {
    document.execCommand(cmd);
  }
}

function requestAISuggest() {
  const area = document.getElementById('writeArea');
  const text = area.innerText.slice(-200);
  addAI(`Based on what you've written, consider exploring: the moment when System 2 stops questioning System 1 is not always about laziness — sometimes it's about <em>trust built through past accuracy</em>. The brain is optimizing, not failing. The question is whether the optimization is calibrated to the current situation.`);
  showToast('AI suggestion sent to Partner panel');
}

function exportMd() {
  const content = document.getElementById('writeArea').innerText;
  const blob = new Blob([content], { type: 'text/markdown' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'writeflow-export.md';
  a.click();
  showToast('Exported as Markdown');
}

function exportPdf() {
  window.print();
}

// ═══════════════════════════════════════
// TOAST
// ═══════════════════════════════════════
let toastTimer;
function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => t.classList.remove('show'), 3000);
}

// ═══════════════════════════════════════
// KEYBOARD SHORTCUTS
// ═══════════════════════════════════════
document.addEventListener('keydown', e => {
  if (e.key === 'Escape') closeModal();
  if (e.metaKey || e.ctrlKey) {
    if (e.key === '1') { e.preventDefault(); switchTab('notes'); }
    if (e.key === '2') { e.preventDefault(); switchTab('ideas'); }
    if (e.key === '3') { e.preventDefault(); switchTab('write'); }
    if (e.key === '4') { e.preventDefault(); switchTab('connections'); }
  }
});

// ═══════════════════════════════════════
// API CLIENT — connects to backend when live
// Falls back to prototype data when offline
// ═══════════════════════════════════════
const API_BASE = '/api';
let CURRENT_BOOK_ID = null; // set after first real book load
let conversationHistory = [];

async function api(method, path, body) {
  try {
    const res = await fetch(API_BASE + path, {
      method,
      headers: { 'Content-Type': 'application/json' },
      body: body ? JSON.stringify(body) : undefined
    });
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    return await res.json();
  } catch (e) {
    // Silently fail — prototype mode keeps working
    console.warn('[API]', method, path, e.message);
    return null;
  }
}

// Load books from backend on init (if available)
async function loadBooksFromAPI() {
  const data = await api('GET', '/books');
  if (data && Array.isArray(data) && data.length > 0) {
    // Merge API books with prototype books array
    data.forEach(b => {
      if (!BOOKS.find(x => x.id === b.id)) {
        BOOKS.unshift({
          id:       b.id,
          title:    b.title,
          author:   b.author || '',
          spine:    b.spine_color || '#1e3a6e',
          progress: b.progress || 0
        });
      }
    });
    CURRENT_BOOK_ID = BOOKS[0].id;
    selectedBook = BOOKS[0].id;
    document.getElementById('barTitle').textContent = BOOKS[0].title;
    document.getElementById('barAuthor').textContent = `— ${BOOKS[0].author}`;
    renderBooks();
    loadBookContent(CURRENT_BOOK_ID);
  }
}

// Real distill — calls OpenAI via backend
async function distillIdeasFromAPI(bookId, chapterName, rawNotes) {
  return await api('POST', '/distill', {
    book_id:      bookId,
    chapter_name: chapterName,
    raw_notes:    rawNotes
  });
}

// Real chat — calls OpenAI via backend
async function chatWithAPI(bookId, message, useLibraryMode) {
  const data = await api('POST', '/chat', {
    book_id:              bookId,
    message,
    conversation_history: conversationHistory.slice(-8),
    library_mode:         useLibraryMode || false
  });
  if (data?.reply) {
    conversationHistory.push({ role: 'user',      content: message });
    conversationHistory.push({ role: 'assistant', content: data.reply });
  }
  return data?.reply || null;
}

// Real article search — calls Serper via backend
async function searchArticlesFromAPI(bookId, conceptQuery) {
  return await api('POST', '/search', {
    book_id:       bookId,
    concept_query: conceptQuery
  });
}

// Real add book — saves to Supabase via backend
async function addBookToAPI(title, author, category, whyReading) {
  return await api('POST', '/books', {
    title, author, category,
    why_reading: whyReading,
    spine_color: getRandomSpine()
  });
}

function getRandomSpine() {
  const colors = ['#1e3a6e','#6e1e1e','#1e4a2e','#4a2a6e','#6e4a2a','#2a5e5e','#5e2a4a'];
  return colors[Math.floor(Math.random() * colors.length)];
}

// Override sendMsg to use real API when CURRENT_BOOK_ID is set
const _sendMsg = sendMsg;

async function sendMsgReal() {
  const input = document.getElementById('chatInput');
  const text = input.value.trim();
  if (!text) return;

  addMsg('user', 'You', text);
  input.value = '';
  input.style.height = 'auto';

  // Show typing
  const chat = document.getElementById('chatMessages');
  const ind = document.createElement('div');
  ind.className = 'typing-ind';
  ind.id = 'typingInd';
  ind.innerHTML = '<div class="t-dot"></div><div class="t-dot"></div><div class="t-dot"></div>';
  chat.appendChild(ind);
  scrollChat();

  let reply = null;
  if (CURRENT_BOOK_ID) {
    reply = await chatWithAPI(CURRENT_BOOK_ID, text, libraryMode);
  }

  ind.remove();
  if (reply) {
    addAI(reply);
  } else {
    // Prototype fallback
    const resp = AI_RESPONSES[responseIdx % AI_RESPONSES.length];
    responseIdx++;
    addAI(resp);
  }
}

// ═══════════════════════════════════════
// LIBRARY MODE TOGGLE
// ═══════════════════════════════════════
function toggleLibraryMode() {
  libraryMode = !libraryMode;
  const btn = document.getElementById('libModeBtn');
  if (libraryMode) {
    btn.classList.add('active');
    btn.innerHTML = `
      <svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/></svg>
      Library ✓
    `;
    showToast('Library Mode on — AI now sees all your books');
  } else {
    btn.classList.remove('active');
    btn.innerHTML = `
      <svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/></svg>
      Library
    `;
    showToast('Library Mode off — single book context');
  }
}

// ═══════════════════════════════════════
// CONNECTIONS — Knowledge Map
// ═══════════════════════════════════════

const KG_PALETTE = ['#c9a84c','#9b8ed4','#5aac8a','#d4836e','#4a9ed4','#d4c44c','#7cc4d4','#c47c8e'];

async function loadCrossBookIdeas() {
  let ideas = [];
  let bookTitle = '', bookAuthor = '';

  if (selectedBook && CURRENT_BOOK_ID) {
    const data = await api('GET', `/distill?book_id=${CURRENT_BOOK_ID}`);
    if (data && data.length > 0) {
      ideas = data;
      const books = await api('GET', '/books');
      if (books) {
        const b = books.find(bk => bk.id === CURRENT_BOOK_ID);
        if (b) { bookTitle = b.title; bookAuthor = b.author || ''; }
      }
    }
  }

  // Fallback to prototype data
  if (ideas.length === 0) {
    const proto = PROTO_CONTENT[selectedBook];
    if (proto) {
      ideas = (proto.ideas || []).map((idea, i) => ({
        id: `p${i}`, title: idea.title, body: idea.body || '', tags: idea.tags || []
      }));
      bookTitle  = proto.title  || '';
      bookAuthor = proto.author || '';
    }
  }

  const sub = document.getElementById('kgSubtitle');
  if (sub) sub.textContent = bookTitle
    ? `Concept connections — ${bookTitle}`
    : 'Concept connections for the current book';

  renderKnowledgeGraph(ideas, { title: bookTitle, author: bookAuthor });
}

// Build full-mesh edges; weight = number of shared tags (+ 0.3 baseline)
function buildKgEdges(nodes) {
  const edges = [];
  for (let i = 0; i < nodes.length; i++) {
    for (let j = i + 1; j < nodes.length; j++) {
      const aTags  = new Set((nodes[i].tags || []).map(t => t.toLowerCase()));
      const bTags  = (nodes[j].tags || []).map(t => t.toLowerCase());
      const shared = bTags.filter(t => aTags.has(t));
      edges.push({ source: i, target: j, weight: shared.length > 0 ? shared.length + 1 : 0.3, shared });
    }
  }
  return edges;
}

// Force-directed layout: 280 iterations, repulsion + spring + gravity
function runForceLayout(nodes, edges, W, H) {
  const IDEAL_BASE  = Math.min(W, H) * 0.28;
  const REPULSION_K = 9000;
  const SPRING_K    = 0.012;
  const GRAVITY     = 0.008;
  const DAMPING     = 0.82;
  const ITERATIONS  = 280;

  nodes.forEach((n, i) => {
    const angle = (2 * Math.PI * i) / nodes.length;
    const r = Math.min(W, H) * 0.3;
    n.x = W / 2 + r * Math.cos(angle);
    n.y = H / 2 + r * Math.sin(angle);
    n.vx = 0; n.vy = 0;
  });

  for (let it = 0; it < ITERATIONS; it++) {
    const alpha  = 1 - it / ITERATIONS;
    const forces = nodes.map(() => ({ fx: 0, fy: 0 }));

    // Repulsion
    for (let i = 0; i < nodes.length; i++) {
      for (let j = i + 1; j < nodes.length; j++) {
        const dx = nodes[j].x - nodes[i].x;
        const dy = nodes[j].y - nodes[i].y;
        const dist = Math.sqrt(dx * dx + dy * dy) || 0.1;
        const f  = REPULSION_K / (dist * dist);
        const fx = (dx / dist) * f, fy = (dy / dist) * f;
        forces[i].fx -= fx; forces[i].fy -= fy;
        forces[j].fx += fx; forces[j].fy += fy;
      }
    }

    // Spring forces along edges
    edges.forEach(e => {
      const a = nodes[e.source], b = nodes[e.target];
      const dx = b.x - a.x, dy = b.y - a.y;
      const dist  = Math.sqrt(dx * dx + dy * dy) || 0.1;
      const ideal = IDEAL_BASE / (e.weight * 0.5 + 0.8);
      const f  = SPRING_K * (dist - ideal);
      const fx = (dx / dist) * f, fy = (dy / dist) * f;
      forces[e.source].fx += fx; forces[e.source].fy += fy;
      forces[e.target].fx -= fx; forces[e.target].fy -= fy;
    });

    // Gravity to centre
    nodes.forEach((n, i) => {
      forces[i].fx += (W / 2 - n.x) * GRAVITY;
      forces[i].fy += (H / 2 - n.y) * GRAVITY;
    });

    // Integrate + clamp
    const pad = 62;
    nodes.forEach((n, i) => {
      n.vx = (n.vx + forces[i].fx * alpha) * DAMPING;
      n.vy = (n.vy + forces[i].fy * alpha) * DAMPING;
      n.x  = Math.max(pad, Math.min(W - pad, n.x + n.vx));
      n.y  = Math.max(pad, Math.min(H - pad, n.y + n.vy));
    });
  }
  return nodes;
}

function renderKnowledgeGraph(ideas, book) {
  const container = document.getElementById('themeClusters');
  if (!ideas || ideas.length === 0) {
    container.innerHTML = `
      <div class="connections-empty">
        <div style="font-size:2rem;margin-bottom:0.75rem;opacity:0.4">◉</div>
        <div>No ideas yet for this book.</div>
        <div style="margin-top:0.5rem;opacity:0.6;font-size:0.8rem">Distil some notes to build the knowledge map.</div>
      </div>`;
    return;
  }

  container.innerHTML = `
    <div class="kg-wrap" id="kgWrap">
      <svg class="kg-svg" id="kgSvg"></svg>
      <div class="kg-tooltip" id="kgTooltip" style="display:none"></div>
    </div>`;

  const wrap = document.getElementById('kgWrap');
  const W = wrap.offsetWidth  || 700;
  const H = wrap.offsetHeight || 520;

  const nodes = ideas.map((idea, i) => ({
    id:    i,
    title: idea.title || 'Untitled',
    body:  (idea.body || '').slice(0, 140),
    tags:  idea.tags  || [],
    color: KG_PALETTE[i % KG_PALETTE.length],
    r:     idea.tags && idea.tags.length > 1 ? 34 : 28
  }));

  const edges = buildKgEdges(nodes);
  runForceLayout(nodes, edges, W, H);

  const svg     = document.getElementById('kgSvg');
  const tooltip = document.getElementById('kgTooltip');
  svg.setAttribute('width', W);
  svg.setAttribute('height', H);
  svg.innerHTML = '';

  // Radial gradient halos
  const defs = document.createElementNS('http://www.w3.org/2000/svg', 'defs');
  nodes.forEach(n => {
    const grad = document.createElementNS('http://www.w3.org/2000/svg', 'radialGradient');
    grad.setAttribute('id', `halo${n.id}`);
    grad.setAttribute('cx', '50%'); grad.setAttribute('cy', '50%'); grad.setAttribute('r', '50%');
    const s1 = document.createElementNS('http://www.w3.org/2000/svg', 'stop');
    s1.setAttribute('offset', '0%');   s1.setAttribute('stop-color', n.color); s1.setAttribute('stop-opacity', '0.35');
    const s2 = document.createElementNS('http://www.w3.org/2000/svg', 'stop');
    s2.setAttribute('offset', '100%'); s2.setAttribute('stop-color', n.color); s2.setAttribute('stop-opacity', '0');
    grad.appendChild(s1); grad.appendChild(s2);
    defs.appendChild(grad);
  });
  svg.appendChild(defs);

  // Edges
  const edgeGroup = document.createElementNS('http://www.w3.org/2000/svg', 'g');
  edges.forEach(e => {
    if (e.weight < 0.5) return;
    const a = nodes[e.source], b = nodes[e.target];
    const mx = (a.x + b.x) / 2, my = (a.y + b.y) / 2;

    const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
    path.setAttribute('d', `M ${a.x} ${a.y} Q ${mx} ${my - 20}, ${b.x} ${b.y}`);
    path.setAttribute('class', 'kg-edge');
    path.setAttribute('stroke', e.weight > 1 ? a.color : '#ffffff');
    path.setAttribute('stroke-width', e.weight > 1 ? String(Math.min(e.weight + 0.5, 3)) : '0.6');
    path.setAttribute('opacity', e.weight > 1 ? '0.4' : '0.1');
    path.setAttribute('fill', 'none');
    path.dataset.src = e.source;
    path.dataset.tgt = e.target;
    edgeGroup.appendChild(path);

    if (e.shared && e.shared.length > 0 && e.weight > 1.5) {
      const label = document.createElementNS('http://www.w3.org/2000/svg', 'text');
      label.setAttribute('x', mx); label.setAttribute('y', my - 24);
      label.setAttribute('class', 'kg-edge-label');
      label.textContent = e.shared[0];
      edgeGroup.appendChild(label);
    }
  });
  svg.appendChild(edgeGroup);

  // Node groups
  const nodeGroup = document.createElementNS('http://www.w3.org/2000/svg', 'g');
  nodes.forEach(n => {
    const g = document.createElementNS('http://www.w3.org/2000/svg', 'g');
    g.setAttribute('class', 'kg-node-group');
    g.setAttribute('transform', `translate(${Math.round(n.x)},${Math.round(n.y)})`);
    g.dataset.nodeId = n.id;

    // Halo
    const halo = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
    halo.setAttribute('r', String(n.r + 16));
    halo.setAttribute('fill', `url(#halo${n.id})`);
    g.appendChild(halo);

    // Circle
    const circ = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
    circ.setAttribute('r', String(n.r));
    circ.setAttribute('class', 'kg-node-circle');
    circ.setAttribute('fill', '#1a1816');
    circ.setAttribute('stroke', n.color);
    circ.setAttribute('stroke-width', '1.8');
    g.appendChild(circ);

    // Wrapped title text
    const lines = wrapKgText(n.title, n.r > 30 ? 14 : 11);
    const lineH = 13, startY = -(lines.length - 1) * lineH / 2;
    lines.forEach((line, li) => {
      const t = document.createElementNS('http://www.w3.org/2000/svg', 'text');
      t.setAttribute('class', 'kg-node-text');
      t.setAttribute('x', '0'); t.setAttribute('y', String(startY + li * lineH));
      t.setAttribute('fill', n.color);
      t.textContent = line;
      g.appendChild(t);
    });

    // Tags below circle
    if (n.tags.length > 0) {
      const tag = document.createElementNS('http://www.w3.org/2000/svg', 'text');
      tag.setAttribute('class', 'kg-tag-text');
      tag.setAttribute('x', '0'); tag.setAttribute('y', String(n.r + 14));
      tag.setAttribute('fill', n.color);
      tag.textContent = n.tags.slice(0, 2).join(' · ');
      g.appendChild(tag);
    }

    g.addEventListener('mouseenter', (evt) => onKgHover(n.id, nodes, edges, svg, tooltip, wrap, evt));
    g.addEventListener('mousemove',  (evt) => positionKgTooltip(tooltip, evt, wrap));
    g.addEventListener('mouseleave', ()    => onKgLeave(svg, tooltip));
    nodeGroup.appendChild(g);
  });
  svg.appendChild(nodeGroup);
}

function wrapKgText(text, maxChars) {
  if (!text) return [''];
  const words = text.split(' ');
  const lines = [];
  let cur = '';
  words.forEach(w => {
    const candidate = (cur ? cur + ' ' : '') + w;
    if (candidate.length > maxChars && cur) { lines.push(cur); cur = w; }
    else cur = candidate;
  });
  if (cur) lines.push(cur);
  return lines.slice(0, 3);
}

function onKgHover(nodeId, nodes, edges, svg, tooltip, wrap, evt) {
  const connected = new Set([nodeId]);
  edges.forEach(e => {
    if (e.source === nodeId) connected.add(e.target);
    if (e.target === nodeId) connected.add(e.source);
  });

  svg.querySelectorAll('.kg-node-group').forEach(g => {
    g.style.opacity = connected.has(parseInt(g.dataset.nodeId)) ? '1' : '0.15';
  });
  svg.querySelectorAll('.kg-edge').forEach(p => {
    const on = connected.has(parseInt(p.dataset.src)) && connected.has(parseInt(p.dataset.tgt));
    p.style.opacity     = on ? '0.85' : '0.04';
    p.style.strokeWidth = on ? '2.5'  : '0.5';
  });

  const n = nodes[nodeId];
  tooltip.innerHTML = `
    <div class="kg-tooltip-title" style="color:${n.color}">${n.title}</div>
    <div style="font-size:0.78rem;line-height:1.5;opacity:0.85;margin-top:0.35rem">${n.body || ''}</div>
    ${n.tags.length ? `<div style="margin-top:0.5rem;font-size:0.72rem">${n.tags.map(t => `<span style="background:${n.color}22;color:${n.color};padding:2px 6px;border-radius:3px;margin-right:4px">${t}</span>`).join('')}</div>` : ''}`;
  tooltip.style.display = '';
  positionKgTooltip(tooltip, evt, wrap);
}

function onKgLeave(svg, tooltip) {
  svg.querySelectorAll('.kg-node-group').forEach(g => { g.style.opacity = ''; });
  svg.querySelectorAll('.kg-edge').forEach(p => { p.style.opacity = ''; p.style.strokeWidth = ''; });
  tooltip.style.display = 'none';
}

function positionKgTooltip(tooltip, evt, wrap) {
  const wr = wrap.getBoundingClientRect();
  const tw = tooltip.offsetWidth  || 220;
  const th = tooltip.offsetHeight || 100;
  let x = evt.clientX - wr.left + 14;
  let y = evt.clientY - wr.top  - 10;
  if (x + tw > wr.width)  x = evt.clientX - wr.left - tw - 14;
  if (y + th > wr.height) y = evt.clientY - wr.top  - th - 14;
  tooltip.style.left = x + 'px';
  tooltip.style.top  = y + 'px';
}

async function generateNarrative() {
  const btn = document.getElementById('narrativeBtn');
  if (btn.classList.contains('loading')) return;
  btn.classList.add('loading');
  btn.innerHTML = `
    <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="animation:spin 1s linear infinite"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg>
    Generating…`;

  let data = await api('POST', '/narrative', {});
  btn.classList.remove('loading');
  btn.innerHTML = `
    <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>
    Generate Macro Narrative`;

  // Prototype fallback — build a narrative from PROTO_CONTENT when backend is unreachable
  if (!data) {
    const allIdeas = Object.values(PROTO_CONTENT).flatMap(b => (b.ideas || []).map(i => `• ${i.title}: ${i.body}`));
    if (allIdeas.length === 0) { showToast('No ideas found — distil some notes first'); return; }
    data = {
      narrative: `Across three very different domains — psychology, military strategy, and behavioural science — a single hidden architecture reveals itself: the machinery of the mind shapes every outcome before conscious choice enters the picture.\n\nKahneman's insight in Thinking, Fast and Slow is that our judgments are largely pre-decided. System 1 constructs a coherent story from available fragments and presents it to System 2 as reality. WYSIATI — "What You See Is All There Is" — means we act on representations of the world, not the world itself. Cognitive ease compounds this: when information is fluent to process, we experience it as familiar and true — which is why repeated exposure alone manufactures belief.\n\nSun Tzu understood this two and a half millennia before neuroscience had vocabulary for it. "All warfare is deception" is not a tactical tip — it is a theory of cognition applied to conflict. Win before you fight means shape the adversary's representation of reality before any engagement begins. The supreme commander is not stronger; they are more accurately modelled in the enemy's mind than the enemy is in theirs. Strategic superiority is epistemic superiority.\n\nJames Clear arrives at the same architecture from the opposite direction. Identity-based habits work because they change the self-model first and behaviour second. Every action is a vote for the type of person you are becoming — which is Kahneman translated into action design. And environment design reduces friction not because friction is physically hard, but because high-friction choices require System 2 activation, which the lazy controller refuses to provide.\n\nThe thread connecting all three books is this: whoever controls the model wins — the model of the self, the model of the enemy, the model of reality. Thinking, deciding, fighting, and habit-building are all contests over which representations get to govern action. Master the model; master the outcome.`
    };
  }

  if (data.error) { showToast(data.error); return; }

  if (data.narrative) {
    const output = document.getElementById('narrativeOutput');
    const prose  = document.getElementById('narrativeProse');
    prose.textContent = data.narrative;
    output.style.display = '';
    output.scrollIntoView({ behavior: 'smooth', block: 'start' });
  }

  showToast('Macro narrative generated');
}

// Swap to real implementation if backend is available
fetch('/api/health').then(r => {
  if (r.ok) {
    window.sendMsg = sendMsgReal;
    loadBooksFromAPI();
    console.log('[WriteFlow] Backend connected ✓');
  }
}).catch(() => {
  console.log('[WriteFlow] Running in prototype mode (no backend)');
});

// ═══════════════════════════════════════
// START
// ═══════════════════════════════════════
init();
</script>
</body>
</html>
