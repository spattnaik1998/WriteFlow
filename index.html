<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>WriteFlow — Idea Distillation Engine</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,500;0,600;0,700;1,400;1,500&family=Inter:wght@300;400;500;600&family=Lora:ital,wght@0,400;0,500;1,400&display=swap" rel="stylesheet">

<style>
/* ===== RESET & ROOT ===== */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --bg-base:        #0f0e0d;
  --bg-sidebar:     #181512;
  --bg-center:      #111009;
  --bg-right:       #181512;
  --bg-card:        #1e1b16;
  --bg-card-hover:  #232019;
  --bg-input:       #141210;
  --border:         #2b2620;
  --border-hi:      #38322a;
  --amber:          #c9a84c;
  --amber-lt:       #e0c06a;
  --amber-dk:       #a0832e;
  --amber-glow:     rgba(201,168,76,0.10);
  --amber-glow2:    rgba(201,168,76,0.20);
  --amber-glow3:    rgba(201,168,76,0.35);
  --text-1:         #ede4d2;
  --text-2:         #b9ad9c;
  --text-3:         #8a7f6e;
  --text-4:         #574f42;
  --green-ok:       #4ade80;
  --sidebar-w:      280px;
  --right-w:        355px;
  --radius:         8px;
  --ease:           0.22s ease;
}

html, body { height: 100%; overflow: hidden; }

body {
  font-family: 'Inter', sans-serif;
  background: var(--bg-base);
  color: var(--text-1);
  display: flex;
  flex-direction: column;
  height: 100vh;
}

/* Grain overlay */
body::after {
  content: '';
  position: fixed;
  inset: 0;
  pointer-events: none;
  z-index: 9999;
  opacity: .028;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='300' height='300'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.75' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='300' height='300' filter='url(%23n)'/%3E%3C/svg%3E");
}

/* Scrollbars */
::-webkit-scrollbar { width: 3px; height: 3px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--border-hi); border-radius: 2px; }

/* ===== LAYOUT ===== */
.app {
  display: flex;
  height: 100vh;
  overflow: hidden;
}

/* ═══════════════════════════════════════
   SIDEBAR
═══════════════════════════════════════ */
.sidebar {
  width: var(--sidebar-w);
  min-width: var(--sidebar-w);
  background: var(--bg-sidebar);
  border-right: 1px solid var(--border);
  display: flex;
  flex-direction: column;
  overflow: hidden;
  transition: width .3s cubic-bezier(.4,0,.2,1), min-width .3s cubic-bezier(.4,0,.2,1);
  position: relative;
}
.sidebar.collapsed { width: 56px; min-width: 56px; }

.sidebar-header {
  padding: 18px 14px 16px;
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  justify-content: space-between;
  flex-shrink: 0;
}

.logo {
  display: flex;
  align-items: center;
  gap: 9px;
  text-decoration: none;
  overflow: hidden;
  white-space: nowrap;
}

.logo-icon {
  width: 30px;
  height: 30px;
  flex-shrink: 0;
  color: var(--amber);
  filter: drop-shadow(0 0 6px var(--amber-glow3));
}

.logo-text {
  font-family: 'Playfair Display', serif;
  font-size: 17px;
  font-weight: 600;
  color: var(--text-1);
  letter-spacing: -.3px;
}
.logo-text span { color: var(--amber); }

.collapse-btn {
  background: none;
  border: none;
  cursor: pointer;
  color: var(--text-4);
  padding: 5px;
  border-radius: 5px;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: var(--ease);
  flex-shrink: 0;
}
.collapse-btn:hover { color: var(--text-2); background: var(--border); }

.sidebar-body {
  flex: 1;
  overflow-y: auto;
  overflow-x: hidden;
  padding: 16px 0 12px;
}

.section-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0 14px 10px;
}
.section-label {
  font-size: 10px;
  font-weight: 600;
  letter-spacing: 1.6px;
  text-transform: uppercase;
  color: var(--text-4);
}

.add-book-btn {
  width: 22px;
  height: 22px;
  background: var(--amber-glow);
  border: 1px solid var(--amber-dk);
  border-radius: 50%;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  color: var(--amber);
  font-size: 15px;
  line-height: 1;
  transition: var(--ease);
}
.add-book-btn:hover {
  background: var(--amber-glow2);
  transform: scale(1.1);
  box-shadow: 0 0 8px var(--amber-glow3);
}

/* Book Cards */
.book-list {
  display: flex;
  flex-direction: column;
  gap: 3px;
  padding: 0 8px;
}

.book-card {
  display: flex;
  align-items: stretch;
  border-radius: var(--radius);
  cursor: pointer;
  transition: var(--ease);
  position: relative;
  overflow: hidden;
  border: 1px solid transparent;
}
.book-card:hover { background: var(--bg-card); border-color: var(--border); }
.book-card.active {
  background: var(--bg-card);
  border-color: var(--border-hi);
  box-shadow: 0 2px 12px rgba(0,0,0,.35), inset 0 0 0 1px var(--amber-glow);
}
.book-card.active::before {
  content: '';
  position: absolute;
  left: 0; top: 0; bottom: 0;
  width: 2px;
  background: linear-gradient(to bottom, var(--amber-lt), var(--amber-dk));
  border-radius: 2px;
}

.book-spine {
  width: 7px;
  flex-shrink: 0;
  border-radius: 4px 0 0 4px;
}

.book-info {
  padding: 10px 10px 10px 11px;
  flex: 1;
  min-width: 0;
}

.book-title {
  font-size: 12.5px;
  font-weight: 500;
  color: var(--text-1);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  line-height: 1.3;
}
.book-author {
  font-size: 11px;
  color: var(--text-3);
  margin-top: 2px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.progress-wrap {
  display: flex;
  align-items: center;
  gap: 6px;
  margin-top: 6px;
}
.progress-bar {
  flex: 1;
  height: 2px;
  background: var(--border);
  border-radius: 1px;
  overflow: hidden;
}
.progress-fill {
  height: 100%;
  background: linear-gradient(to right, var(--amber-dk), var(--amber));
  border-radius: 1px;
  transition: width .5s ease;
}
.progress-pct {
  font-size: 10px;
  color: var(--text-4);
}

/* Sidebar footer */
.sidebar-footer {
  padding: 12px 14px;
  border-top: 1px solid var(--border);
  flex-shrink: 0;
  display: flex;
  align-items: center;
  gap: 8px;
}
.sidebar-footer-avatar {
  width: 28px;
  height: 28px;
  border-radius: 50%;
  background: linear-gradient(135deg, var(--amber-dk), #6b4a1a);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 11px;
  font-weight: 600;
  color: var(--text-1);
  flex-shrink: 0;
}
.sidebar-footer-name {
  font-size: 12px;
  font-weight: 500;
  color: var(--text-3);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

/* ═══════════════════════════════════════
   CENTER PANEL
═══════════════════════════════════════ */
.center-panel {
  flex: 1;
  background: var(--bg-center);
  display: flex;
  flex-direction: column;
  overflow: hidden;
  border-right: 1px solid var(--border);
}

.center-header {
  padding: 16px 24px 0;
  border-bottom: 1px solid var(--border);
  flex-shrink: 0;
}

.book-bar {
  display: flex;
  align-items: baseline;
  gap: 10px;
  padding-bottom: 13px;
}
.book-bar-title {
  font-family: 'Playfair Display', serif;
  font-size: 19px;
  font-weight: 600;
  color: var(--text-1);
  letter-spacing: -.3px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.book-bar-author {
  font-size: 13px;
  color: var(--text-3);
  white-space: nowrap;
}

.tab-nav {
  display: flex;
  gap: 0;
}
.tab-btn {
  background: none;
  border: none;
  cursor: pointer;
  padding: 9px 16px;
  font-family: 'Inter', sans-serif;
  font-size: 13px;
  font-weight: 500;
  color: var(--text-3);
  position: relative;
  transition: color var(--ease);
  display: flex;
  align-items: center;
  gap: 6px;
  letter-spacing: .1px;
}
.tab-btn::after {
  content: '';
  position: absolute;
  bottom: -1px;
  left: 0; right: 0;
  height: 2px;
  background: var(--amber);
  transform: scaleX(0);
  transition: transform .22s cubic-bezier(.4,0,.2,1);
  border-radius: 1px;
}
.tab-btn:hover { color: var(--text-2); }
.tab-btn.active { color: var(--amber); }
.tab-btn.active::after { transform: scaleX(1); }

/* Tab Panes */
.tab-content {
  flex: 1;
  overflow: hidden;
  position: relative;
}
.tab-pane {
  position: absolute;
  inset: 0;
  overflow-y: auto;
  padding: 22px 24px 28px;
  opacity: 0;
  transform: translateY(6px);
  pointer-events: none;
  transition: opacity .22s ease, transform .22s ease;
}
.tab-pane.active {
  opacity: 1;
  transform: translateY(0);
  pointer-events: auto;
}

/* ═══════════════════════════════════════
   NOTES TAB
═══════════════════════════════════════ */
.chapter-row {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 14px;
}
.chapter-select {
  flex: 1;
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  color: var(--text-1);
  font-family: 'Inter', sans-serif;
  font-size: 13px;
  padding: 9px 34px 9px 12px;
  cursor: pointer;
  transition: var(--ease);
  outline: none;
  appearance: none;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%238a7f6e' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 10px center;
}
.chapter-select option { background: var(--bg-card); }
.chapter-select:focus {
  border-color: var(--amber-dk);
  box-shadow: 0 0 0 3px var(--amber-glow);
}

.btn-add-chapter {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  color: var(--text-3);
  font-family: 'Inter', sans-serif;
  font-size: 12px;
  padding: 9px 13px;
  cursor: pointer;
  white-space: nowrap;
  transition: var(--ease);
  display: flex;
  align-items: center;
  gap: 5px;
}
.btn-add-chapter:hover { color: var(--text-2); border-color: var(--border-hi); }

.notes-textarea {
  width: 100%;
  min-height: 190px;
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 10px;
  color: var(--text-1);
  font-family: 'Lora', serif;
  font-size: 14px;
  line-height: 1.82;
  padding: 16px 18px;
  resize: vertical;
  outline: none;
  transition: border-color var(--ease), box-shadow var(--ease);
}
.notes-textarea::placeholder { color: var(--text-4); font-style: italic; }
.notes-textarea:focus {
  border-color: var(--amber-dk);
  box-shadow: 0 0 0 3px var(--amber-glow);
}

.action-row {
  display: flex;
  gap: 9px;
  margin-top: 13px;
}

/* Primary amber button */
.btn-amber {
  flex: 1;
  padding: 10px 18px;
  background: linear-gradient(135deg, #c9a84c 0%, #a07828 100%);
  border: none;
  border-radius: var(--radius);
  color: #18130a;
  font-family: 'Inter', sans-serif;
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  transition: var(--ease);
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 7px;
  box-shadow: 0 2px 14px rgba(201,168,76,.22), inset 0 1px 0 rgba(255,255,255,.12);
  letter-spacing: .2px;
}
.btn-amber:hover {
  background: linear-gradient(135deg, #dfc06a 0%, #c9a84c 100%);
  box-shadow: 0 4px 22px rgba(201,168,76,.42), inset 0 1px 0 rgba(255,255,255,.15);
  transform: translateY(-1px);
}
.btn-amber:active { transform: translateY(0); }
.btn-amber.loading {
  animation: amberPulse 1.4s ease-in-out infinite;
  pointer-events: none;
  cursor: wait;
}
@keyframes amberPulse {
  0%,100% { box-shadow: 0 2px 14px rgba(201,168,76,.22); }
  50%      { box-shadow: 0 4px 28px rgba(201,168,76,.55); }
}
@keyframes spin {
  from { transform: rotate(0deg); }
  to   { transform: rotate(360deg); }
}

/* Secondary button */
.btn-sec {
  padding: 10px 16px;
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  color: var(--text-2);
  font-family: 'Inter', sans-serif;
  font-size: 13px;
  font-weight: 500;
  cursor: pointer;
  transition: var(--ease);
  display: flex;
  align-items: center;
  gap: 7px;
}
.btn-sec:hover { border-color: var(--border-hi); color: var(--text-1); background: var(--bg-card-hover); }

/* Accordion */
.accordion-label {
  font-size: 10px;
  font-weight: 600;
  letter-spacing: 1.4px;
  text-transform: uppercase;
  color: var(--text-4);
  margin: 22px 0 10px;
}
.accordion { display: flex; flex-direction: column; gap: 5px; }

.accordion-item {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  overflow: hidden;
  transition: border-color var(--ease);
}
.accordion-item.open { border-color: var(--border-hi); }

.accordion-head {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 11px 13px;
  cursor: pointer;
  user-select: none;
  transition: background var(--ease);
}
.accordion-head:hover { background: var(--bg-card-hover); }

.acc-title {
  font-size: 12.5px;
  font-weight: 500;
  color: var(--text-2);
}
.acc-meta { font-size: 11px; color: var(--text-4); margin-top: 1px; }

.acc-chevron {
  color: var(--text-4);
  transition: transform .22s ease;
  flex-shrink: 0;
}
.accordion-item.open .acc-chevron { transform: rotate(180deg); }

.accordion-body {
  max-height: 0;
  overflow: hidden;
  transition: max-height .28s cubic-bezier(.4,0,.2,1);
}
.accordion-item.open .accordion-body { max-height: 250px; }

.acc-content {
  padding: 12px 13px 13px;
  border-top: 1px solid var(--border);
  font-family: 'Lora', serif;
  font-size: 13px;
  line-height: 1.72;
  color: var(--text-3);
}

/* ═══════════════════════════════════════
   IDEAS TAB
═══════════════════════════════════════ */
.themes-bar {
  display: flex;
  align-items: center;
  gap: 7px;
  flex-wrap: wrap;
  margin-bottom: 18px;
}
.themes-bar-label {
  font-size: 10px;
  font-weight: 600;
  letter-spacing: 1.2px;
  text-transform: uppercase;
  color: var(--text-4);
}
.theme-pill {
  padding: 4px 11px;
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 20px;
  font-size: 11.5px;
  color: var(--text-3);
  cursor: pointer;
  transition: var(--ease);
}
.theme-pill:hover, .theme-pill.active {
  background: var(--amber-glow);
  border-color: var(--amber-dk);
  color: var(--amber);
}

.ideas-grid {
  columns: 2;
  column-gap: 14px;
}

.idea-card {
  break-inside: avoid;
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 17px;
  margin-bottom: 14px;
  transition: border-color var(--ease), box-shadow var(--ease), transform var(--ease);
  animation: cardReveal .5s ease both;
}
.idea-card:nth-child(1) { animation-delay: 0s; }
.idea-card:nth-child(2) { animation-delay: .07s; }
.idea-card:nth-child(3) { animation-delay: .14s; }
.idea-card:nth-child(4) { animation-delay: .21s; }
@keyframes cardReveal {
  from { opacity: 0; transform: translateY(14px) scale(.98); }
  to   { opacity: 1; transform: translateY(0) scale(1); }
}
.idea-card:hover {
  border-color: var(--border-hi);
  box-shadow: 0 5px 20px rgba(0,0,0,.35);
  transform: translateY(-2px);
}

.idea-num {
  font-size: 10px;
  font-weight: 600;
  color: var(--amber);
  opacity: .7;
  letter-spacing: .6px;
  margin-bottom: 7px;
}
.idea-title {
  font-family: 'Playfair Display', serif;
  font-size: 15px;
  font-weight: 600;
  color: var(--text-1);
  line-height: 1.35;
  margin-bottom: 9px;
}
.idea-body {
  font-size: 12.5px;
  line-height: 1.72;
  color: var(--text-3);
  margin-bottom: 13px;
}
.idea-tags {
  display: flex;
  gap: 5px;
  flex-wrap: wrap;
  margin-bottom: 13px;
}
.idea-tag {
  font-size: 9.5px;
  font-weight: 500;
  padding: 2px 7px;
  background: var(--amber-glow);
  border: 1px solid var(--amber-glow2);
  border-radius: 4px;
  color: var(--amber-dk);
  letter-spacing: .3px;
}
.idea-explore {
  background: none;
  border: 1px solid var(--border-hi);
  border-radius: 5px;
  color: var(--text-3);
  font-family: 'Inter', sans-serif;
  font-size: 11.5px;
  padding: 5px 11px;
  cursor: pointer;
  transition: var(--ease);
  display: flex;
  align-items: center;
  gap: 5px;
}
.idea-explore:hover {
  border-color: var(--amber-dk);
  color: var(--amber);
  background: var(--amber-glow);
}

/* ═══════════════════════════════════════
   WRITE TAB
═══════════════════════════════════════ */
.write-toolbar {
  display: flex;
  gap: 3px;
  padding: 7px 10px;
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius) var(--radius) 0 0;
  border-bottom: none;
}
.toolbar-btn {
  background: none;
  border: none;
  color: var(--text-3);
  cursor: pointer;
  padding: 5px 9px;
  border-radius: 5px;
  font-family: 'Inter', sans-serif;
  font-size: 12px;
  font-weight: 500;
  transition: var(--ease);
  display: flex;
  align-items: center;
  gap: 4px;
}
.toolbar-btn:hover { color: var(--text-1); background: var(--border); }
.toolbar-sep { width: 1px; height: 18px; background: var(--border); align-self: center; margin: 0 3px; }

.write-area {
  min-height: 320px;
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 0 0 var(--radius) var(--radius);
  color: var(--text-1);
  font-family: 'Lora', serif;
  font-size: 15px;
  line-height: 1.88;
  padding: 24px 28px;
  outline: none;
  caret-color: var(--amber);
  transition: border-color var(--ease);
}
.write-area:focus { border-color: var(--amber-dk); }
.write-area:empty::before {
  content: 'Begin writing your synthesis here...';
  color: var(--text-4);
  font-style: italic;
  pointer-events: none;
}
.write-area h2 {
  font-family: 'Playfair Display', serif;
  font-size: 21px;
  font-weight: 600;
  color: var(--text-1);
  margin-bottom: 13px;
  line-height: 1.3;
}
.write-area blockquote {
  border-left: 3px solid var(--amber-dk);
  padding-left: 15px;
  color: var(--text-3);
  font-style: italic;
  margin: 16px 0;
}
.write-area p { margin-bottom: 12px; }

.export-row {
  display: flex;
  gap: 8px;
  margin-top: 12px;
  justify-content: flex-end;
}

/* ═══════════════════════════════════════
   RIGHT PANEL — AI PARTNER
═══════════════════════════════════════ */
.right-panel {
  width: var(--right-w);
  min-width: var(--right-w);
  background: var(--bg-right);
  border-left: 1px solid var(--border);
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

.right-header {
  padding: 14px 18px;
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  gap: 10px;
  flex-shrink: 0;
}
.status-dot {
  width: 8px;
  height: 8px;
  background: var(--green-ok);
  border-radius: 50%;
  flex-shrink: 0;
  animation: dotPulse 2.2s ease-in-out infinite;
}
@keyframes dotPulse {
  0%,100% { box-shadow: 0 0 0 0 rgba(74,222,128,.5); }
  60%      { box-shadow: 0 0 0 5px rgba(74,222,128,0); }
}
.right-hdr-info { flex: 1; }
.right-hdr-title {
  font-family: 'Playfair Display', serif;
  font-size: 14px;
  font-weight: 600;
  color: var(--text-1);
}
.right-hdr-sub { font-size: 11px; color: var(--text-4); margin-top: 1px; }

/* Chat */
.chat-section {
  flex: 1;
  display: flex;
  flex-direction: column;
  overflow: hidden;
  border-bottom: 1px solid var(--border);
  min-height: 0;
}
.chat-messages {
  flex: 1;
  overflow-y: auto;
  padding: 14px 14px 6px;
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.chat-msg { display: flex; flex-direction: column; gap: 3px; animation: msgIn .28s ease both; }
@keyframes msgIn {
  from { opacity: 0; transform: translateY(6px); }
  to   { opacity: 1; transform: translateY(0); }
}

.msg-sender {
  font-size: 9.5px;
  font-weight: 600;
  letter-spacing: .9px;
  text-transform: uppercase;
  color: var(--text-4);
  padding: 0 2px;
}
.chat-msg.user .msg-sender { text-align: right; }

.msg-bubble {
  padding: 9px 12px;
  font-size: 12.5px;
  line-height: 1.65;
  color: var(--text-2);
  max-width: 92%;
}
.chat-msg.ai .msg-bubble {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 3px 10px 10px 10px;
  align-self: flex-start;
}
.chat-msg.user .msg-bubble {
  background: var(--amber-glow2);
  border: 1px solid rgba(201,168,76,.25);
  border-radius: 10px 3px 10px 10px;
  align-self: flex-end;
  color: var(--text-1);
}
.msg-bubble em {
  color: var(--amber-lt);
  font-style: normal;
  font-weight: 500;
}

/* Typing indicator */
.typing-ind {
  display: flex;
  align-items: center;
  gap: 4px;
  padding: 9px 13px;
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 3px 10px 10px 10px;
  align-self: flex-start;
}
.t-dot {
  width: 5px;
  height: 5px;
  background: var(--text-4);
  border-radius: 50%;
  animation: tDot 1.1s ease-in-out infinite;
}
.t-dot:nth-child(2) { animation-delay: .18s; }
.t-dot:nth-child(3) { animation-delay: .36s; }
@keyframes tDot {
  0%,80%,100% { transform: scale(.65); opacity: .4; }
  40%          { transform: scale(1); opacity: 1; }
}

.chat-input-row {
  padding: 10px 14px 12px;
  display: flex;
  gap: 7px;
  flex-shrink: 0;
  align-items: flex-end;
}
.chat-input {
  flex: 1;
  background: var(--bg-input);
  border: 1px solid var(--border);
  border-radius: 9px;
  color: var(--text-1);
  font-family: 'Inter', sans-serif;
  font-size: 12.5px;
  padding: 8px 11px;
  resize: none;
  outline: none;
  min-height: 38px;
  max-height: 110px;
  line-height: 1.5;
  transition: border-color var(--ease), box-shadow var(--ease);
}
.chat-input::placeholder { color: var(--text-4); }
.chat-input:focus {
  border-color: var(--amber-dk);
  box-shadow: 0 0 0 3px var(--amber-glow);
}
.send-btn {
  width: 36px;
  height: 36px;
  background: linear-gradient(135deg, var(--amber), var(--amber-dk));
  border: none;
  border-radius: 8px;
  color: #14100a;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: var(--ease);
  flex-shrink: 0;
  box-shadow: 0 2px 8px rgba(201,168,76,.3);
}
.send-btn:hover {
  background: linear-gradient(135deg, var(--amber-lt), var(--amber));
  transform: scale(1.07);
  box-shadow: 0 4px 14px rgba(201,168,76,.5);
}

/* Blog Discoveries */
.blog-panel {
  flex-shrink: 0;
  max-height: 270px;
  overflow-y: auto;
  border-top: 1px solid var(--border);
  padding: 12px 14px 14px;
}
.blog-panel-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 10px;
}
.blog-panel-title {
  font-size: 10px;
  font-weight: 600;
  letter-spacing: 1.4px;
  text-transform: uppercase;
  color: var(--text-4);
}
.blog-searching {
  display: none;
  align-items: center;
  gap: 4px;
  font-size: 10px;
  color: var(--text-4);
}
.blog-searching.on { display: flex; }
.s-dot {
  width: 4px; height: 4px;
  background: var(--amber);
  border-radius: 50%;
  animation: tDot 1s ease-in-out infinite;
}
.s-dot:nth-child(2) { animation-delay: .14s; }
.s-dot:nth-child(3) { animation-delay: .28s; }

.blog-list { display: flex; flex-direction: column; gap: 7px; }
.blog-card {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 9px 11px;
  display: flex;
  align-items: flex-start;
  gap: 9px;
  transition: var(--ease);
  animation: msgIn .28s ease both;
}
.blog-card:hover { border-color: var(--border-hi); background: var(--bg-card-hover); }
.blog-favicon {
  width: 20px; height: 20px;
  border-radius: 4px;
  background: var(--border);
  flex-shrink: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 8px;
  font-weight: 700;
  color: var(--text-3);
  margin-top: 1px;
}
.blog-info { flex: 1; min-width: 0; }
.blog-card-title {
  font-size: 11.5px;
  font-weight: 500;
  color: var(--text-2);
  line-height: 1.4;
  margin-bottom: 2px;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
}
.blog-domain { font-size: 10px; color: var(--text-4); }
.blog-read {
  background: none;
  border: 1px solid var(--border);
  border-radius: 4px;
  color: var(--text-4);
  font-size: 10px;
  font-weight: 500;
  padding: 3px 8px;
  cursor: pointer;
  transition: var(--ease);
  white-space: nowrap;
  align-self: center;
  flex-shrink: 0;
}
.blog-read:hover { border-color: var(--amber-dk); color: var(--amber); }

/* ═══════════════════════════════════════
   MODAL
═══════════════════════════════════════ */
.modal-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.72);
  backdrop-filter: blur(6px);
  z-index: 1000;
  display: flex;
  align-items: center;
  justify-content: center;
  opacity: 0;
  pointer-events: none;
  transition: opacity .22s ease;
}
.modal-overlay.open { opacity: 1; pointer-events: auto; }

.modal {
  background: var(--bg-sidebar);
  border: 1px solid var(--border-hi);
  border-radius: 14px;
  padding: 28px;
  width: 440px;
  max-width: calc(100vw - 48px);
  transform: translateY(22px) scale(.97);
  transition: transform .26s cubic-bezier(.34,1.56,.64,1);
  box-shadow: 0 32px 80px rgba(0,0,0,.7), 0 0 0 1px rgba(201,168,76,.08);
}
.modal-overlay.open .modal { transform: translateY(0) scale(1); }

.modal-title {
  font-family: 'Playfair Display', serif;
  font-size: 19px;
  font-weight: 600;
  color: var(--text-1);
  margin-bottom: 4px;
}
.modal-sub { font-size: 13px; color: var(--text-3); margin-bottom: 22px; }

.form-group { margin-bottom: 15px; }
.form-label {
  display: block;
  font-size: 11.5px;
  font-weight: 500;
  color: var(--text-3);
  margin-bottom: 5px;
  letter-spacing: .2px;
}
.form-input, .form-ta {
  width: 100%;
  background: var(--bg-input);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  color: var(--text-1);
  font-family: 'Inter', sans-serif;
  font-size: 13px;
  padding: 9px 12px;
  outline: none;
  transition: border-color var(--ease), box-shadow var(--ease);
}
.form-input::placeholder, .form-ta::placeholder { color: var(--text-4); }
.form-input:focus, .form-ta:focus {
  border-color: var(--amber-dk);
  box-shadow: 0 0 0 3px var(--amber-glow);
}
.form-ta { min-height: 80px; resize: vertical; line-height: 1.6; }

.modal-actions {
  display: flex;
  gap: 9px;
  justify-content: flex-end;
  margin-top: 22px;
}
.btn-ghost {
  padding: 9px 17px;
  background: none;
  border: 1px solid var(--border);
  border-radius: 7px;
  color: var(--text-3);
  font-family: 'Inter', sans-serif;
  font-size: 13px;
  cursor: pointer;
  transition: var(--ease);
}
.btn-ghost:hover { color: var(--text-1); border-color: var(--border-hi); }

/* Success toast */
.toast {
  position: fixed;
  bottom: 28px;
  right: 28px;
  background: var(--bg-card);
  border: 1px solid var(--border-hi);
  border-left: 3px solid var(--amber);
  border-radius: var(--radius);
  padding: 12px 18px;
  font-size: 13px;
  color: var(--text-1);
  z-index: 2000;
  transform: translateY(60px);
  opacity: 0;
  transition: transform .3s cubic-bezier(.34,1.56,.64,1), opacity .3s ease;
  pointer-events: none;
  box-shadow: 0 8px 32px rgba(0,0,0,.4);
}
.toast.show { transform: translateY(0); opacity: 1; }

/* ===== THEME PILL HOVER ===== */
.theme-pill { cursor: pointer; }

/* ═══════════════════════════════════════
   STANCE BADGES
═══════════════════════════════════════ */
.stance-badge {
  display: inline-flex;
  align-items: center;
  font-size: 9px;
  font-weight: 600;
  letter-spacing: .5px;
  text-transform: uppercase;
  padding: 2px 7px;
  border-radius: 10px;
  margin-bottom: 4px;
  border: 1px solid;
}
.stance-badge.supporting {
  background: rgba(74,222,128,.10);
  border-color: rgba(74,222,128,.25);
  color: #4ade80;
}
.stance-badge.opposing {
  background: rgba(248,113,113,.10);
  border-color: rgba(248,113,113,.25);
  color: #f87171;
}
.stance-badge.neutral {
  background: var(--bg-card);
  border-color: var(--border);
  color: var(--text-4);
}

/* ═══════════════════════════════════════
   CONNECTIONS TAB
═══════════════════════════════════════ */
.connections-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 22px;
  flex-wrap: wrap;
  gap: 10px;
}
.connections-title {
  font-family: 'Playfair Display', serif;
  font-size: 16px;
  font-weight: 600;
  color: var(--text-1);
}
.connections-sub {
  font-size: 12px;
  color: var(--text-4);
  margin-top: 2px;
}

.theme-cluster {
  margin-bottom: 28px;
}
.theme-cluster-heading {
  font-size: 10px;
  font-weight: 600;
  letter-spacing: 1.6px;
  text-transform: uppercase;
  color: var(--amber-dk);
  margin-bottom: 10px;
  display: flex;
  align-items: center;
  gap: 8px;
}
.theme-cluster-heading::after {
  content: '';
  flex: 1;
  height: 1px;
  background: var(--border);
}

.cross-ideas-row {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.cross-idea-card {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 10px;
  padding: 13px 14px;
  position: relative;
  transition: border-color var(--ease), box-shadow var(--ease);
  animation: cardReveal .4s ease both;
}
.cross-idea-card:hover {
  border-color: var(--border-hi);
  box-shadow: 0 4px 16px rgba(0,0,0,.3);
}
.cross-idea-book-badge {
  display: inline-flex;
  align-items: center;
  font-size: 9.5px;
  font-weight: 600;
  padding: 2px 8px;
  background: var(--amber-glow);
  border: 1px solid var(--amber-glow2);
  border-radius: 10px;
  color: var(--amber-dk);
  letter-spacing: .2px;
  margin-bottom: 7px;
}
.cross-idea-title {
  font-family: 'Playfair Display', serif;
  font-size: 13.5px;
  font-weight: 600;
  color: var(--text-1);
  line-height: 1.35;
  margin-bottom: 5px;
}
.cross-idea-body {
  font-size: 12px;
  line-height: 1.65;
  color: var(--text-3);
  display: -webkit-box;
  -webkit-line-clamp: 3;
  -webkit-box-orient: vertical;
  overflow: hidden;
}

.narrative-section {
  margin-top: 28px;
  padding-top: 22px;
  border-top: 1px solid var(--border);
}
.narrative-label {
  font-size: 10px;
  font-weight: 600;
  letter-spacing: 1.6px;
  text-transform: uppercase;
  color: var(--text-4);
  margin-bottom: 14px;
}
.narrative-prose {
  border-left: 3px solid var(--amber-dk);
  padding-left: 18px;
  font-family: 'Lora', serif;
  font-size: 14px;
  line-height: 1.85;
  color: var(--text-2);
  font-style: italic;
}

.connections-empty {
  text-align: center;
  padding: 48px 20px;
  color: var(--text-4);
  font-size: 13px;
  line-height: 1.7;
}
.connections-empty svg {
  color: var(--text-4);
  margin-bottom: 12px;
  opacity: .4;
}

/* Library mode toggle */
.lib-mode-btn {
  background: none;
  border: 1px solid var(--border);
  border-radius: 6px;
  color: var(--text-4);
  font-family: 'Inter', sans-serif;
  font-size: 10.5px;
  font-weight: 500;
  padding: 4px 10px;
  cursor: pointer;
  transition: var(--ease);
  display: flex;
  align-items: center;
  gap: 5px;
  white-space: nowrap;
  flex-shrink: 0;
}
.lib-mode-btn:hover {
  color: var(--text-2);
  border-color: var(--border-hi);
}
.lib-mode-btn.active {
  background: var(--amber-glow);
  border-color: var(--amber-dk);
  color: var(--amber);
}
</style>
</head>
<body>

<div class="app">

  <!-- ═══════════ SIDEBAR ═══════════ -->
  <aside class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <a class="logo" href="#">
        <!-- Quill SVG -->
        <svg class="logo-icon" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M27 3C27 3 19 6 14.5 13C10 20 9 28 9 28L11.5 25.5C11.5 25.5 12.5 21 16 17" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
          <path d="M27 3L7 29" stroke="currentColor" stroke-width="1.4" stroke-linecap="round"/>
          <path d="M14.5 13C14.5 13 17 11 21 10C25 9 27 3 27 3C27 3 22 8 18 11C16 12 14.5 13 14.5 13Z" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round" fill="currentColor" fill-opacity="0.22"/>
          <circle cx="9" cy="28" r="1" fill="currentColor" opacity="0.6"/>
        </svg>
        <span class="logo-text">Write<span>Flow</span></span>
      </a>
      <button class="collapse-btn" onclick="toggleSidebar()" title="Toggle sidebar">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M15 18l-6-6 6-6"/>
        </svg>
      </button>
    </div>

    <div class="sidebar-body">
      <div style="padding: 0 0 8px">
        <div class="section-header">
          <span class="section-label">My Library</span>
          <button class="add-book-btn" onclick="openModal()" title="Add new book">+</button>
        </div>
        <div class="book-list" id="bookList"></div>
      </div>
    </div>

    <div class="sidebar-footer">
      <div class="sidebar-footer-avatar">R</div>
      <div class="sidebar-footer-name">Your Reading Space</div>
    </div>
  </aside>

  <!-- ═══════════ CENTER PANEL ═══════════ -->
  <main class="center-panel">
    <div class="center-header">
      <div class="book-bar">
        <div class="book-bar-title" id="barTitle">Thinking, Fast and Slow</div>
        <div class="book-bar-author" id="barAuthor">— Daniel Kahneman</div>
      </div>
      <nav class="tab-nav">
        <button class="tab-btn active" id="tabNotes" onclick="switchTab('notes')">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>
          Notes
        </button>
        <button class="tab-btn" id="tabIdeas" onclick="switchTab('ideas')">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
          Ideas
        </button>
        <button class="tab-btn" id="tabWrite" onclick="switchTab('write')">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
          Write
        </button>
        <button class="tab-btn" id="tabConnections" onclick="switchTab('connections')">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/></svg>
          Connections
        </button>
      </nav>
    </div>

    <div class="tab-content">

      <!-- NOTES TAB -->
      <div class="tab-pane active" id="pane-notes">
        <div class="chapter-row">
          <select class="chapter-select" id="chapterSelect">
            <option>Chapter 1 — Two Systems</option>
            <option>Chapter 2 — Attention and Effort</option>
            <option selected>Chapter 3 — The Lazy Controller</option>
            <option>Chapter 4 — The Associative Machine</option>
          </select>
          <button class="btn-add-chapter">
            <svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
            Chapter
          </button>
        </div>

        <textarea class="notes-textarea" id="mainNotes" rows="8">Kahneman opens with something brilliant — there are two ways we think. One is fast, automatic, like recognizing a face or reading anger in someone's voice. The other is slow, deliberate, like solving 17×24. The fast one (System 1) runs without us noticing. It's always on. The slow one (System 2) is lazy — it only engages when needed. Key: System 1 is constantly generating impressions and jumping to conclusions. System 2 mostly just endorses these without scrutiny. This is simultaneously terrifying and fascinating. The gorilla experiment. We don't see what we're not looking for.</textarea>

        <div class="action-row">
          <button class="btn-amber" id="distillBtn" onclick="distillIdeas()">
            <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 3H5a2 2 0 0 0-2 2v4m6-6h10a2 2 0 0 1 2 2v4M9 3v18m0 0h10a2 2 0 0 0 2-2V9M9 21H5a2 2 0 0 1-2-2V9m0 0h18"/></svg>
            Distill Ideas
          </button>
          <button class="btn-sec" onclick="findBlogArticles()">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
            Find Articles
          </button>
        </div>

        <div class="accordion-label">Chapter Notes</div>
        <div class="accordion">
          <div class="accordion-item open" id="acc-1">
            <div class="accordion-head" onclick="toggleAcc('1')">
              <div>
                <div class="acc-title">Chapter 1 — Two Systems</div>
                <div class="acc-meta">64 words · 3 hours ago</div>
              </div>
              <svg class="acc-chevron" width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
            </div>
            <div class="accordion-body">
              <div class="acc-content">The book opens by establishing that human cognition is dual-layered. System 1 operates automatically — it reads emotions, recognizes faces, understands sentences without effort. System 2 is deliberate and expensive. The key insight: System 2 doesn't supervise System 1 continuously. It mostly accepts what System 1 presents.</div>
            </div>
          </div>

          <div class="accordion-item" id="acc-2">
            <div class="accordion-head" onclick="toggleAcc('2')">
              <div>
                <div class="acc-title">Chapter 2 — Attention & Effort</div>
                <div class="acc-meta">51 words · Yesterday</div>
              </div>
              <svg class="acc-chevron" width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
            </div>
            <div class="accordion-body">
              <div class="acc-content">Pupils dilate visibly during hard mental work — cognitive effort is literally physical. The battery metaphor: System 2 drains a finite resource. This is why important decisions made late in the day are worse. Ego depletion is real. Glucose restores deliberate thinking capacity. The implications for scheduling and decision-making are enormous.</div>
            </div>
          </div>

          <div class="accordion-item" id="acc-3">
            <div class="accordion-head" onclick="toggleAcc('3')">
              <div>
                <div class="acc-title">Chapter 3 — The Lazy Controller</div>
                <div class="acc-meta">48 words · 12 minutes ago</div>
              </div>
              <svg class="acc-chevron" width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
            </div>
            <div class="accordion-body">
              <div class="acc-content">We are cognitive misers by design. The bat and ball problem: $1.10 total, bat costs $1 more than the ball. Most say 10 cents. It's 5 cents. The intuitive answer feels fluent — and that fluency signals correctness to System 1. System 2 doesn't check unless prompted. This is WYSIATI in action.</div>
            </div>
          </div>
        </div>
      </div>

      <!-- IDEAS TAB -->
      <div class="tab-pane" id="pane-ideas">
        <div class="themes-bar">
          <span class="themes-bar-label">Themes</span>
          <span class="theme-pill active" onclick="togglePill(this)">Cognition</span>
          <span class="theme-pill" onclick="togglePill(this)">Decision-Making</span>
          <span class="theme-pill" onclick="togglePill(this)">Bias</span>
          <span class="theme-pill" onclick="togglePill(this)">Psychology</span>
          <span class="theme-pill" onclick="togglePill(this)">Behavior</span>
        </div>

        <div class="ideas-grid" id="ideasGrid">
          <div class="idea-card">
            <div class="idea-num">INSIGHT 01</div>
            <div class="idea-title">System 1 vs System 2 Thinking</div>
            <div class="idea-body">Human cognition runs on two parallel tracks. System 1 is automatic, instant, and constantly running — shaping almost every moment-to-moment perception. System 2 is deliberate and effortful, but dangerously passive: it tends to endorse whatever System 1 serves up, rarely questioning the source.</div>
            <div class="idea-tags">
              <span class="idea-tag">DUAL PROCESS</span>
              <span class="idea-tag">AUTOMATICITY</span>
            </div>
            <button class="idea-explore" onclick="exploreIdea('System 1 vs System 2')">
              <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M5 12h14m-7-7l7 7-7 7"/></svg>
              Explore Further
            </button>
          </div>

          <div class="idea-card">
            <div class="idea-num">INSIGHT 02</div>
            <div class="idea-title">The WYSIATI Principle</div>
            <div class="idea-body">What You See Is All There Is. System 1 constructs the most coherent narrative possible from available data — without ever noting what information is absent. This is why snap judgments feel complete and confident even when built on a fraction of what's relevant.</div>
            <div class="idea-tags">
              <span class="idea-tag">NARRATIVE BIAS</span>
              <span class="idea-tag">OVERCONFIDENCE</span>
            </div>
            <button class="idea-explore" onclick="exploreIdea('WYSIATI')">
              <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M5 12h14m-7-7l7 7-7 7"/></svg>
              Explore Further
            </button>
          </div>

          <div class="idea-card">
            <div class="idea-num">INSIGHT 03</div>
            <div class="idea-title">Anchoring Effect in Decision Making</div>
            <div class="idea-body">The first number encountered in any estimation contaminates all subsequent judgments — even when you know it's arbitrary. Kahneman showed that judges assigned shorter sentences after rolling low dice numbers. The anchor operates below the threshold of conscious awareness, making it nearly impossible to correct for.</div>
            <div class="idea-tags">
              <span class="idea-tag">ANCHORING</span>
              <span class="idea-tag">PRIMING</span>
              <span class="idea-tag">HEURISTICS</span>
            </div>
            <button class="idea-explore" onclick="exploreIdea('Anchoring Effect')">
              <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M5 12h14m-7-7l7 7-7 7"/></svg>
              Explore Further
            </button>
          </div>

          <div class="idea-card">
            <div class="idea-num">INSIGHT 04</div>
            <div class="idea-title">Cognitive Ease &amp; the Illusion of Truth</div>
            <div class="idea-body">When information is easy to process, we experience it as familiar, true, and credible. This is cognitive ease — and it's weaponizable. Repetition doesn't create truth, but it creates the <em>feeling</em> of truth. This is why propaganda relies on repetition, not argument. Fluency masquerades as validity.</div>
            <div class="idea-tags">
              <span class="idea-tag">COGNITIVE EASE</span>
              <span class="idea-tag">FLUENCY</span>
              <span class="idea-tag">TRUTH PERCEPTION</span>
            </div>
            <button class="idea-explore" onclick="exploreIdea('Cognitive Ease')">
              <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M5 12h14m-7-7l7 7-7 7"/></svg>
              Explore Further
            </button>
          </div>
        </div>
      </div>

      <!-- WRITE TAB -->
      <div class="tab-pane" id="pane-write">
        <div class="write-toolbar">
          <button class="toolbar-btn" onclick="execFmt('bold')" title="Bold">
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M6 4h8a4 4 0 0 1 4 4 4 4 0 0 1-4 4H6z"/><path d="M6 12h9a4 4 0 0 1 4 4 4 4 0 0 1-4 4H6z"/></svg>
            Bold
          </button>
          <button class="toolbar-btn" onclick="execFmt('italic')" title="Italic">
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="19" y1="4" x2="10" y2="4"/><line x1="14" y1="20" x2="5" y2="20"/><line x1="15" y1="4" x2="9" y2="20"/></svg>
            Italic
          </button>
          <div class="toolbar-sep"></div>
          <button class="toolbar-btn" onclick="execFmt('heading')" title="Heading">
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 12h16M4 6h7M4 18h7m7-12v12"/></svg>
            Heading
          </button>
          <button class="toolbar-btn" onclick="execFmt('blockquote')" title="Quote">
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 21c3 0 7-1 7-8V5c0-1.25-.756-2.017-2-2H4c-1.25 0-2 .75-2 1.972V11c0 1.25.75 2 2 2 1 0 1 0 1 1v1c0 1-1 2-2 2s-1 .008-1 1.031V20c0 1 0 1 1 1z"/><path d="M15 21c3 0 7-1 7-8V5c0-1.25-.757-2.017-2-2h-4c-1.25 0-2 .75-2 1.972V11c0 1.25.75 2 2 2h.75c0 2.25.25 4-2.75 4v3c0 1 0 1 1 1z"/></svg>
            Quote
          </button>
          <div class="toolbar-sep"></div>
          <button class="toolbar-btn" style="color:var(--amber-dk)" onclick="requestAISuggest()">
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>
            AI Suggest
          </button>
        </div>

        <div class="write-area" id="writeArea" contenteditable="true">
          <h2>The Hidden Architecture of Thought</h2>
          <p>Daniel Kahneman's central thesis is deceptively simple: we do not think as much as we believe we do. The mind operates on two parallel systems — one fast and automatic, one slow and deliberate — and the deliberate one is far more passive than our self-image suggests.</p>
          <blockquote>What You See Is All There Is. The mind builds coherent stories from available information, never asking what might be missing from the picture.</blockquote>
          <p>The implications cascade outward. If System 1 generates the vast majority of our judgments, and System 2 mostly just endorses them, then our cherished sense of careful deliberation is largely an illusion. We are not rational agents who occasionally err. We are intuitive agents who occasionally reflect.</p>
        </div>

        <div class="export-row">
          <button class="btn-sec" style="font-size:12px" onclick="exportMd()">
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
            Export Markdown
          </button>
          <button class="btn-amber" style="flex:0;padding:9px 15px;font-size:12px" onclick="exportPdf()">
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
            Export PDF
          </button>
        </div>
      </div>

      <!-- CONNECTIONS TAB -->
      <div class="tab-pane" id="pane-connections">
        <div class="connections-header">
          <div>
            <div class="connections-title">Ideas Across Your Library</div>
            <div class="connections-sub">Thematic clusters from all your books</div>
          </div>
          <button class="btn-amber" id="narrativeBtn" onclick="generateNarrative()" style="flex:0;padding:9px 14px;font-size:12px">
            <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>
            Generate Macro Narrative
          </button>
        </div>
        <div id="themeClusters"></div>
        <div id="narrativeOutput" style="display:none">
          <div class="narrative-section">
            <div class="narrative-label">Macro Narrative</div>
            <div class="narrative-prose" id="narrativeProse"></div>
          </div>
        </div>
      </div>

    </div><!-- /tab-content -->
  </main>

  <!-- ═══════════ RIGHT PANEL ═══════════ -->
  <aside class="right-panel">
    <div class="right-header">
      <div class="status-dot"></div>
      <div class="right-hdr-info">
        <div class="right-hdr-title">Reading Partner</div>
        <div class="right-hdr-sub">Ready to explore ideas with you</div>
      </div>
      <button class="lib-mode-btn" id="libModeBtn" onclick="toggleLibraryMode()" title="Toggle Library Mode — gives the AI context from all your books">
        <svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/></svg>
        Library
      </button>
    </div>

    <div class="chat-section">
      <div class="chat-messages" id="chatMessages">
        <div class="chat-msg ai">
          <div class="msg-sender">Partner</div>
          <div class="msg-bubble">I've been reading through your Chapter 3 notes. Kahneman is building toward a profound insight about <em>cognitive ease</em> — the feeling when thinking flows without friction. Want to explore how this connects to your earlier observations?</div>
        </div>
        <div class="chat-msg user">
          <div class="msg-sender">You</div>
          <div class="msg-bubble">Yes, tell me more about cognitive ease</div>
        </div>
        <div class="chat-msg ai">
          <div class="msg-sender">Partner</div>
          <div class="msg-bubble">Cognitive ease is Kahneman's term for the subjective experience of <em>fluent processing</em> — and here's what's disturbing: that fluency gets mis-registered as truth. Your note about "things feeling true when familiar" is exactly this.<br><br>Familiarity and truth become indistinguishable to System 1. This is why repetition creates belief — not evidence, not argument. Just <em>repetition</em>. The propaganda implications are enormous.</div>
        </div>
      </div>

      <div class="chat-input-row">
        <textarea class="chat-input" id="chatInput" placeholder="Ask about your notes, push an idea further..." rows="1" onkeydown="onChatKey(event)" oninput="autoResize(this)"></textarea>
        <button class="send-btn" onclick="sendMsg()">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
        </button>
      </div>
    </div>

    <!-- Blog Panel -->
    <div class="blog-panel">
      <div class="blog-panel-header">
        <div class="blog-panel-title">Blog Discoveries</div>
        <div class="blog-searching" id="blogSearching">
          <div class="s-dot"></div><div class="s-dot"></div><div class="s-dot"></div>
          <span style="font-size:10px;color:var(--text-4)">Searching...</span>
        </div>
      </div>
      <div class="blog-list" id="blogList">
        <div class="blog-card">
          <div class="blog-favicon">FS</div>
          <div class="blog-info">
            <div class="blog-card-title">Why Your Brain Takes Shortcuts: The Science Behind Cognitive Bias</div>
            <div class="blog-domain">fs.blog</div>
          </div>
          <button class="blog-read">Read</button>
        </div>
        <div class="blog-card" style="animation-delay:.05s">
          <div class="blog-favicon">LW</div>
          <div class="blog-info">
            <div class="blog-card-title">Dual Process Theory: How System 1 and 2 Shape Every Decision You Make</div>
            <div class="blog-domain">lesswrong.com</div>
          </div>
          <button class="blog-read">Read</button>
        </div>
        <div class="blog-card" style="animation-delay:.1s">
          <div class="blog-favicon">MD</div>
          <div class="blog-info">
            <div class="blog-card-title">WYSIATI: The Mental Model That Explains Why We're So Often Wrong</div>
            <div class="blog-domain">medium.com</div>
          </div>
          <button class="blog-read">Read</button>
        </div>
      </div>
    </div>
  </aside>

</div><!-- /app -->

<!-- Add Book Modal -->
<div class="modal-overlay" id="modalOverlay" onclick="outsideClose(event)">
  <div class="modal">
    <div class="modal-title">Add to Your Library</div>
    <div class="modal-sub">What are you reading?</div>
    <div class="form-group">
      <label class="form-label">Book Title</label>
      <input class="form-input" id="newTitle" type="text" placeholder="e.g. The Pragmatic Programmer">
    </div>
    <div class="form-group">
      <label class="form-label">Author</label>
      <input class="form-input" id="newAuthor" type="text" placeholder="e.g. David Thomas, Andy Hunt">
    </div>
    <div class="form-group">
      <label class="form-label">Category</label>
      <input class="form-input" id="newCat" type="text" placeholder="e.g. Philosophy, Business, Science">
    </div>
    <div class="form-group">
      <label class="form-label">Why are you reading this?</label>
      <textarea class="form-ta" id="newWhy" placeholder="What drew you to this book? What do you hope to discover in it?"></textarea>
    </div>
    <div class="modal-actions">
      <button class="btn-ghost" onclick="closeModal()">Cancel</button>
      <button class="btn-amber" style="flex:0;padding:9px 20px" onclick="addBook()">Add Book</button>
    </div>
  </div>
</div>

<!-- Toast notification -->
<div class="toast" id="toast"></div>

<script>
// ═══════════════════════════════════════
// DATA
// ═══════════════════════════════════════
const BOOKS = [
  { id: 'tfs', title: 'Thinking, Fast and Slow', author: 'Daniel Kahneman', spine: '#1e3a6e', progress: 62 },
  { id: 'aow', title: 'The Art of War',          author: 'Sun Tzu',           spine: '#6e1e1e', progress: 100 },
  { id: 'ah',  title: 'Atomic Habits',           author: 'James Clear',       spine: '#1e4a2e', progress: 35  }
];

let selectedBook = 'tfs';
let activeTab = 'notes';
let responseIdx = 0;
let libraryMode = false;

const AI_RESPONSES = [
  "That's a rich angle. Your notes are already gesturing toward what Kahneman calls the <em>narrative fallacy</em> — the tendency to build a coherent story from whatever fragments we have, then mistake that story for the truth. The coherence is the danger.",
  "Think about the implication for your own reading. When a chapter clicks — when it feels like you really understood it — that's cognitive ease talking. The real question Kahneman would ask: what are you NOT seeing right now? What is your WYSIATI?",
  "There's a beautiful paradox here worth exploring: the act of writing notes forces System 2 online. By externalizing thoughts, you're offloading working memory, which actually lets System 2 operate on bigger ideas. Feynman knew this. Darwin kept meticulous notebooks for exactly this reason.",
  "Kahneman's anchoring research points to something uncomfortable: knowing about a bias does not protect you from it. You can know anchoring exists, accept the dice roll was random, and still be influenced. This is why institutional design matters more than individual willpower.",
  "The connection you're sensing is real. Cognitive ease, familiarity, fluency, and the feeling of truth are all the same underlying signal. Your brain uses <em>ease of processing</em> as a proxy for validity — an elegant heuristic that works most of the time and fails catastrophically in exactly the situations that matter most.",
  "Here's a synthesis worth capturing: Systems 1 and 2 aren't adversaries — they're collaborators with a flawed division of labor. System 1 is supposed to handle the routine; System 2 handles the novel. The problem is System 1 doesn't always know when something is genuinely novel. It treats the unfamiliar as familiar and moves on."
];

// ═══════════════════════════════════════
// INIT
// ═══════════════════════════════════════
function init() {
  renderBooks();
  scrollChat();
}

// ═══════════════════════════════════════
// BOOKS
// ═══════════════════════════════════════
function renderBooks() {
  const list = document.getElementById('bookList');
  list.innerHTML = BOOKS.map(b => `
    <div class="book-card ${b.id === selectedBook ? 'active' : ''}" onclick="selectBook('${b.id}')">
      <div class="book-spine" style="background:${b.spine}"></div>
      <div class="book-info">
        <div class="book-title">${b.title}</div>
        <div class="book-author">${b.author}</div>
        <div class="progress-wrap">
          <div class="progress-bar"><div class="progress-fill" style="width:${b.progress}%"></div></div>
          <span class="progress-pct">${b.progress}%</span>
        </div>
      </div>
    </div>
  `).join('');
}

function selectBook(id) {
  CURRENT_BOOK_ID = id;
  selectedBook = id;
  const b = BOOKS.find(x => x.id === id);
  document.getElementById('barTitle').textContent = b.title;
  document.getElementById('barAuthor').textContent = `— ${b.author}`;
  renderBooks();
  showToast(`Switched to "${b.title}"`);

  // Reset conversation history for the new book
  conversationHistory = [];

  // Load this book's notes + ideas from the API
  if (CURRENT_BOOK_ID) loadBookContent(CURRENT_BOOK_ID);
}

async function loadBookContent(bookId) {
  // Fetch notes and ideas in parallel
  const [notes, ideas] = await Promise.all([
    api('GET', `/notes?book_id=${bookId}`),
    api('GET', `/distill?book_id=${bookId}`)
  ]);

  // ── Notes tab ──────────────────────────────────────────
  const chapterSelect = document.getElementById('chapterSelect');
  const mainNotes     = document.getElementById('mainNotes');
  const accordion     = document.querySelector('.accordion');

  if (notes && notes.length > 0) {
    // Populate chapter dropdown
    chapterSelect.innerHTML = notes.map(n =>
      `<option value="${n.chapter_name}">${n.chapter_name}</option>`
    ).join('');

    // Show first chapter's content in the textarea
    mainNotes.value = notes[0].content || '';

    // Update accordion with all chapters
    accordion.innerHTML = notes.map((n, i) => `
      <div class="accordion-item ${i === 0 ? 'open' : ''}" id="acc-book-${i}">
        <div class="accordion-head" onclick="this.parentElement.classList.toggle('open')">
          <div>
            <div class="acc-title">${n.chapter_name}</div>
            <div class="acc-meta">${n.word_count || 0} words</div>
          </div>
          <svg class="acc-chevron" width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
        </div>
        <div class="accordion-body">
          <div class="acc-content">${n.content || ''}</div>
        </div>
      </div>
    `).join('');

    // When chapter is changed in dropdown, update textarea
    chapterSelect.onchange = () => {
      const selected = notes.find(n => n.chapter_name === chapterSelect.value);
      if (selected) mainNotes.value = selected.content || '';
    };
  } else {
    // No notes yet for this book — show empty state
    chapterSelect.innerHTML = '<option>Chapter 1</option>';
    mainNotes.value = '';
    accordion.innerHTML = `<div style="padding:14px 0;font-size:12.5px;color:var(--text-4)">No notes yet for this book. Start typing above.</div>`;
  }

  // ── Ideas tab ──────────────────────────────────────────
  const grid = document.getElementById('ideasGrid');
  grid.innerHTML = '';

  if (ideas && ideas.length > 0) {
    ideas.forEach((idea, i) => {
      const card = document.createElement('div');
      card.className = 'idea-card';
      card.style.animationDelay = `${i * 0.07}s`;
      card.innerHTML = `
        <div class="idea-num">INSIGHT ${String(idea.number || i + 1).padStart(2, '0')}</div>
        <div class="idea-title">${idea.title}</div>
        <div class="idea-body">${idea.body}</div>
        <div class="idea-tags">${(idea.tags || []).map(t => `<span class="idea-tag">${t}</span>`).join('')}</div>
        <button class="idea-explore" onclick="exploreIdea('${idea.title.replace(/'/g, "\\'")}')">
          <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M5 12h14m-7-7l7 7-7 7"/></svg>
          Explore Further
        </button>
      `;
      grid.appendChild(card);
    });
  } else {
    grid.innerHTML = `<div style="padding:24px 0;font-size:12.5px;color:var(--text-4);grid-column:1/-1">No ideas yet — write some notes and hit Distill Ideas.</div>`;
  }

  // ── Blog panel ─────────────────────────────────────────
  document.getElementById('blogList').innerHTML = '';
}

// ═══════════════════════════════════════
// SIDEBAR
// ═══════════════════════════════════════
function toggleSidebar() {
  document.getElementById('sidebar').classList.toggle('collapsed');
}

// ═══════════════════════════════════════
// TABS
// ═══════════════════════════════════════
let connectionsLoaded = false;
function switchTab(tab) {
  document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  document.getElementById(`pane-${tab}`).classList.add('active');
  document.getElementById(`tab${tab.charAt(0).toUpperCase() + tab.slice(1)}`).classList.add('active');
  activeTab = tab;
  if (tab === 'connections' && !connectionsLoaded) {
    connectionsLoaded = true;
    loadCrossBookIdeas();
  }
}

// ═══════════════════════════════════════
// ACCORDION
// ═══════════════════════════════════════
function toggleAcc(id) {
  document.getElementById(`acc-${id}`).classList.toggle('open');
}

// ═══════════════════════════════════════
// DISTILL IDEAS
// ═══════════════════════════════════════
function distillIdeas() {
  const btn = document.getElementById('distillBtn');
  if (btn.classList.contains('loading')) return;
  btn.classList.add('loading');
  btn.innerHTML = `
    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="animation:spin 1s linear infinite">
      <path d="M21 12a9 9 0 1 1-6.219-8.56"/>
    </svg>
    Distilling...
  `;

  const chapterName = document.getElementById('chapterSelect').value;
  const rawNotes    = document.getElementById('mainNotes').value;

  // Try real API first
  const doDistil = async () => {
    if (CURRENT_BOOK_ID) {
      const result = await distillIdeasFromAPI(CURRENT_BOOK_ID, chapterName, rawNotes);
      if (result?.ideas?.length) {
        renderIdeasFromAPI(result.ideas);
      }
    }
    btn.classList.remove('loading');
    btn.innerHTML = `
      <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M9 3H5a2 2 0 0 0-2 2v4m6-6h10a2 2 0 0 1 2 2v4M9 3v18m0 0h10a2 2 0 0 0 2-2V9M9 21H5a2 2 0 0 1-2-2V9m0 0h18"/>
      </svg>
      Distill Ideas
    `;
    switchTab('ideas');
    setTimeout(() => {
      addAI("I've crystallized your notes into core insights. The thread running through all of them: <em>the gap between what we believe we're doing cognitively and what we're actually doing</em>. Want to start with WYSIATI? It's the gravitational centre of the book.");
    }, 400);
  };

  setTimeout(doDistil, 2400);
}

// ═══════════════════════════════════════
// RENDER REAL IDEA CARDS
// ═══════════════════════════════════════
function renderIdeasFromAPI(ideas) {
  const grid = document.getElementById('ideasGrid');
  // Append new cards rather than replacing (prototype cards stay)
  ideas.forEach((idea, i) => {
    const card = document.createElement('div');
    card.className = 'idea-card';
    card.style.animationDelay = `${i * 0.07}s`;
    card.innerHTML = `
      <div class="idea-num">INSIGHT ${String(idea.number || i + 1).padStart(2, '0')}</div>
      <div class="idea-title">${idea.title}</div>
      <div class="idea-body">${idea.body}</div>
      <div class="idea-tags">${(idea.tags || []).map(t => `<span class="idea-tag">${t}</span>`).join('')}</div>
      <button class="idea-explore" onclick="exploreIdea('${idea.title.replace(/'/g, "\\'")}')">
        <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M5 12h14m-7-7l7 7-7 7"/></svg>
        Explore Further
      </button>
    `;
    grid.appendChild(card);
  });
}

// ═══════════════════════════════════════
// FIND BLOG ARTICLES
// ═══════════════════════════════════════
function findBlogArticles() {
  const searching = document.getElementById('blogSearching');
  const list = document.getElementById('blogList');
  searching.classList.add('on');
  list.style.opacity = '.35';
  list.style.pointerEvents = 'none';

  const doSearch = async () => {
    let articles = null;

    if (CURRENT_BOOK_ID) {
      articles = await searchArticlesFromAPI(CURRENT_BOOK_ID, null);
    }

    searching.classList.remove('on');
    list.style.opacity = '1';
    list.style.pointerEvents = '';

    if (articles && articles.length) {
      // Replace prototype cards with real results
      list.innerHTML = '';
      articles.forEach((a, i) => {
        const initials = a.domain.split('.')[0].slice(0, 2).toUpperCase();
        const card = document.createElement('div');
        card.className = 'blog-card';
        card.style.animationDelay = `${i * 0.05}s`;
        if (i === 0) card.style.borderColor = 'var(--amber-dk)';
        const stanceBadge = a.stance && a.stance !== 'neutral'
          ? `<span class="stance-badge ${a.stance}">${a.stance}</span>`
          : (a.stance === 'neutral' ? `<span class="stance-badge neutral">neutral</span>` : '');
        card.innerHTML = `
          <div class="blog-favicon">${initials}</div>
          <div class="blog-info">
            <div class="blog-card-title">${a.title}</div>
            <div class="blog-domain">${a.domain}</div>
            ${stanceBadge}
          </div>
          <button class="blog-read" onclick="window.open('${a.url}','_blank')">${i === 0 ? 'New' : 'Read'}</button>
        `;
        list.appendChild(card);
      });
      addAI(`Found ${articles.length} relevant articles. The top result from ${articles[0]?.domain} looks particularly strong — want me to pull out the key ideas so you can cross-reference with your notes?`);
    } else {
      // Prototype fallback
      const card = document.createElement('div');
      card.className = 'blog-card';
      card.style.borderColor = 'var(--amber-dk)';
      card.innerHTML = `
        <div class="blog-favicon" style="background:var(--amber-glow);color:var(--amber-dk)">HB</div>
        <div class="blog-info">
          <div class="blog-card-title">Kahneman's System 1 & 2: The Neuroscience Behind Why We Think What We Think</div>
          <div class="blog-domain">hubermanlab.com</div>
        </div>
        <button class="blog-read" style="border-color:var(--amber-dk);color:var(--amber)">New</button>
      `;
      list.insertBefore(card, list.firstChild);
      setTimeout(() => {
        addAI("Found 4 relevant articles. The Farnam Street piece is particularly strong — it builds a direct bridge between cognitive ease and the mental models framework. Highly relevant to your Chapter 3 notes.");
      }, 500);
    }
  };

  setTimeout(doSearch, 1900);
}

// ═══════════════════════════════════════
// IDEA EXPLORE
// ═══════════════════════════════════════
function exploreIdea(concept) {
  addAI(`Let's go deep on <em>${concept}</em>. What's the connection you're trying to make? I can pull threads from your other notes, or we can stress-test the idea against what you've read so far.`);
}

// ═══════════════════════════════════════
// THEME PILLS
// ═══════════════════════════════════════
function togglePill(el) {
  el.classList.toggle('active');
}

// ═══════════════════════════════════════
// CHAT
// ═══════════════════════════════════════
function onChatKey(e) {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    sendMsg();
  }
}

function autoResize(el) {
  el.style.height = 'auto';
  el.style.height = Math.min(el.scrollHeight, 110) + 'px';
}

function sendMsg() {
  const input = document.getElementById('chatInput');
  const text = input.value.trim();
  if (!text) return;

  addMsg('user', 'You', text);
  input.value = '';
  input.style.height = 'auto';

  // Typing indicator
  const chat = document.getElementById('chatMessages');
  const ind = document.createElement('div');
  ind.className = 'typing-ind';
  ind.id = 'typingInd';
  ind.innerHTML = '<div class="t-dot"></div><div class="t-dot"></div><div class="t-dot"></div>';
  chat.appendChild(ind);
  scrollChat();

  const delay = 1200 + Math.random() * 900;
  setTimeout(() => {
    ind.remove();
    const resp = AI_RESPONSES[responseIdx % AI_RESPONSES.length];
    responseIdx++;
    addAI(resp);
  }, delay);
}

function addMsg(type, sender, text) {
  const chat = document.getElementById('chatMessages');
  const div = document.createElement('div');
  div.className = `chat-msg ${type}`;
  div.innerHTML = `
    <div class="msg-sender">${sender}</div>
    <div class="msg-bubble">${text}</div>
  `;
  chat.appendChild(div);
  scrollChat();
}

function addAI(html) {
  const chat = document.getElementById('chatMessages');
  const div = document.createElement('div');
  div.className = 'chat-msg ai';
  const bubble = document.createElement('div');
  bubble.className = 'msg-bubble';
  div.innerHTML = '<div class="msg-sender">Partner</div>';
  div.appendChild(bubble);
  chat.appendChild(div);
  scrollChat();
  typeWords(bubble, html, 28);
}

function typeWords(el, html, interval) {
  const words = html.split(' ');
  let i = 0;
  el.innerHTML = '';

  const tick = setInterval(() => {
    if (i >= words.length) {
      clearInterval(tick);
      el.innerHTML = html; // Restore full HTML with tags
      scrollChat();
      return;
    }
    // Show plain text during typing
    const plain = html.replace(/<[^>]*>/g, '');
    const plainWords = plain.split(' ');
    el.textContent = plainWords.slice(0, i + 1).join(' ') + (i < words.length - 1 ? '…' : '');
    i += 1 + (i % 3 === 0 ? 1 : 0); // Slightly variable speed
    scrollChat();
  }, interval);
}

function scrollChat() {
  const chat = document.getElementById('chatMessages');
  requestAnimationFrame(() => { chat.scrollTop = chat.scrollHeight; });
}

// ═══════════════════════════════════════
// MODAL
// ═══════════════════════════════════════
function openModal() {
  document.getElementById('modalOverlay').classList.add('open');
  setTimeout(() => document.getElementById('newTitle').focus(), 280);
}

function closeModal() {
  document.getElementById('modalOverlay').classList.remove('open');
}

function outsideClose(e) {
  if (e.target === document.getElementById('modalOverlay')) closeModal();
}

async function addBook() {
  const title  = document.getElementById('newTitle').value.trim();
  const author = document.getElementById('newAuthor').value.trim();
  const cat    = document.getElementById('newCat').value.trim();
  const why    = document.getElementById('newWhy').value.trim();
  if (!title) { document.getElementById('newTitle').focus(); return; }

  const colors = ['#2a3f6e','#6e2a2a','#2a5e3a','#4a2a6e','#6e4a2a','#2a5e5e','#2a5e8e'];
  const spine  = colors[BOOKS.length % colors.length];

  // Optimistic UI update
  const tempId = 'temp-' + Date.now();
  BOOKS.push({ id: tempId, title, author: author || 'Unknown Author', spine, progress: 0 });
  renderBooks();
  closeModal();
  ['newTitle','newAuthor','newCat','newWhy'].forEach(fid => document.getElementById(fid).value = '');
  showToast(`"${title}" added to your library`);

  // Persist to Supabase in background
  const saved = await addBookToAPI(title, author, cat, why);
  if (saved?.id) {
    const idx = BOOKS.findIndex(b => b.id === tempId);
    if (idx > -1) BOOKS[idx].id = saved.id;
    if (!CURRENT_BOOK_ID) CURRENT_BOOK_ID = saved.id;
  }
}

// ═══════════════════════════════════════
// WRITE TOOLBAR
// ═══════════════════════════════════════
function execFmt(cmd) {
  const area = document.getElementById('writeArea');
  area.focus();
  if (cmd === 'heading') {
    document.execCommand('formatBlock', false, 'h2');
  } else if (cmd === 'blockquote') {
    document.execCommand('formatBlock', false, 'blockquote');
  } else {
    document.execCommand(cmd);
  }
}

function requestAISuggest() {
  const area = document.getElementById('writeArea');
  const text = area.innerText.slice(-200);
  addAI(`Based on what you've written, consider exploring: the moment when System 2 stops questioning System 1 is not always about laziness — sometimes it's about <em>trust built through past accuracy</em>. The brain is optimizing, not failing. The question is whether the optimization is calibrated to the current situation.`);
  showToast('AI suggestion sent to Partner panel');
}

function exportMd() {
  const content = document.getElementById('writeArea').innerText;
  const blob = new Blob([content], { type: 'text/markdown' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'writeflow-export.md';
  a.click();
  showToast('Exported as Markdown');
}

function exportPdf() {
  window.print();
}

// ═══════════════════════════════════════
// TOAST
// ═══════════════════════════════════════
let toastTimer;
function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => t.classList.remove('show'), 3000);
}

// ═══════════════════════════════════════
// KEYBOARD SHORTCUTS
// ═══════════════════════════════════════
document.addEventListener('keydown', e => {
  if (e.key === 'Escape') closeModal();
  if (e.metaKey || e.ctrlKey) {
    if (e.key === '1') { e.preventDefault(); switchTab('notes'); }
    if (e.key === '2') { e.preventDefault(); switchTab('ideas'); }
    if (e.key === '3') { e.preventDefault(); switchTab('write'); }
    if (e.key === '4') { e.preventDefault(); switchTab('connections'); }
  }
});

// ═══════════════════════════════════════
// API CLIENT — connects to backend when live
// Falls back to prototype data when offline
// ═══════════════════════════════════════
const API_BASE = '/api';
let CURRENT_BOOK_ID = null; // set after first real book load
let conversationHistory = [];

async function api(method, path, body) {
  try {
    const res = await fetch(API_BASE + path, {
      method,
      headers: { 'Content-Type': 'application/json' },
      body: body ? JSON.stringify(body) : undefined
    });
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    return await res.json();
  } catch (e) {
    // Silently fail — prototype mode keeps working
    console.warn('[API]', method, path, e.message);
    return null;
  }
}

// Load books from backend on init (if available)
async function loadBooksFromAPI() {
  const data = await api('GET', '/books');
  if (data && Array.isArray(data) && data.length > 0) {
    // Merge API books with prototype books array
    data.forEach(b => {
      if (!BOOKS.find(x => x.id === b.id)) {
        BOOKS.unshift({
          id:       b.id,
          title:    b.title,
          author:   b.author || '',
          spine:    b.spine_color || '#1e3a6e',
          progress: b.progress || 0
        });
      }
    });
    CURRENT_BOOK_ID = BOOKS[0].id;
    selectedBook = BOOKS[0].id;
    document.getElementById('barTitle').textContent = BOOKS[0].title;
    document.getElementById('barAuthor').textContent = `— ${BOOKS[0].author}`;
    renderBooks();
    loadBookContent(CURRENT_BOOK_ID);
  }
}

// Real distill — calls OpenAI via backend
async function distillIdeasFromAPI(bookId, chapterName, rawNotes) {
  return await api('POST', '/distill', {
    book_id:      bookId,
    chapter_name: chapterName,
    raw_notes:    rawNotes
  });
}

// Real chat — calls OpenAI via backend
async function chatWithAPI(bookId, message, useLibraryMode) {
  const data = await api('POST', '/chat', {
    book_id:              bookId,
    message,
    conversation_history: conversationHistory.slice(-8),
    library_mode:         useLibraryMode || false
  });
  if (data?.reply) {
    conversationHistory.push({ role: 'user',      content: message });
    conversationHistory.push({ role: 'assistant', content: data.reply });
  }
  return data?.reply || null;
}

// Real article search — calls Serper via backend
async function searchArticlesFromAPI(bookId, conceptQuery) {
  return await api('POST', '/search', {
    book_id:       bookId,
    concept_query: conceptQuery
  });
}

// Real add book — saves to Supabase via backend
async function addBookToAPI(title, author, category, whyReading) {
  return await api('POST', '/books', {
    title, author, category,
    why_reading: whyReading,
    spine_color: getRandomSpine()
  });
}

function getRandomSpine() {
  const colors = ['#1e3a6e','#6e1e1e','#1e4a2e','#4a2a6e','#6e4a2a','#2a5e5e','#5e2a4a'];
  return colors[Math.floor(Math.random() * colors.length)];
}

// Override sendMsg to use real API when CURRENT_BOOK_ID is set
const _sendMsg = sendMsg;

async function sendMsgReal() {
  const input = document.getElementById('chatInput');
  const text = input.value.trim();
  if (!text) return;

  addMsg('user', 'You', text);
  input.value = '';
  input.style.height = 'auto';

  // Show typing
  const chat = document.getElementById('chatMessages');
  const ind = document.createElement('div');
  ind.className = 'typing-ind';
  ind.id = 'typingInd';
  ind.innerHTML = '<div class="t-dot"></div><div class="t-dot"></div><div class="t-dot"></div>';
  chat.appendChild(ind);
  scrollChat();

  let reply = null;
  if (CURRENT_BOOK_ID) {
    reply = await chatWithAPI(CURRENT_BOOK_ID, text, libraryMode);
  }

  ind.remove();
  if (reply) {
    addAI(reply);
  } else {
    // Prototype fallback
    const resp = AI_RESPONSES[responseIdx % AI_RESPONSES.length];
    responseIdx++;
    addAI(resp);
  }
}

// ═══════════════════════════════════════
// LIBRARY MODE TOGGLE
// ═══════════════════════════════════════
function toggleLibraryMode() {
  libraryMode = !libraryMode;
  const btn = document.getElementById('libModeBtn');
  if (libraryMode) {
    btn.classList.add('active');
    btn.innerHTML = `
      <svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/></svg>
      Library ✓
    `;
    showToast('Library Mode on — AI now sees all your books');
  } else {
    btn.classList.remove('active');
    btn.innerHTML = `
      <svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/></svg>
      Library
    `;
    showToast('Library Mode off — single book context');
  }
}

// ═══════════════════════════════════════
// CONNECTIONS TAB
// ═══════════════════════════════════════
async function loadCrossBookIdeas() {
  const container = document.getElementById('themeClusters');
  container.innerHTML = `<div class="connections-empty">
    <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/></svg>
    <br>Loading ideas from your library…
  </div>`;

  const data = await api('GET', '/narrative/ideas');
  if (!data || !data.books) return;

  const booksWithIdeas = data.books.filter(b => b.ideas && b.ideas.length > 0);
  if (booksWithIdeas.length === 0) {
    container.innerHTML = `<div class="connections-empty">
      <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/></svg>
      <br>No ideas yet. Distil notes from at least two books<br>to see cross-library connections here.
    </div>`;
    return;
  }

  renderThemeClusters(booksWithIdeas);
}

function renderThemeClusters(books) {
  const container = document.getElementById('themeClusters');
  container.innerHTML = '';
  books.forEach(book => {
    if (!book.ideas || book.ideas.length === 0) return;
    const cluster = document.createElement('div');
    cluster.className = 'theme-cluster';
    const heading = document.createElement('div');
    heading.className = 'theme-cluster-heading';
    heading.textContent = book.title;
    const row = document.createElement('div');
    row.className = 'cross-ideas-row';
    book.ideas.forEach((idea, i) => {
      const card = document.createElement('div');
      card.className = 'cross-idea-card';
      card.style.animationDelay = `${i * 0.05}s`;
      card.innerHTML = `
        <div class="cross-idea-book-badge">${book.author || ''}</div>
        <div class="cross-idea-title">${idea.title}</div>
        <div class="cross-idea-body">${idea.body || ''}</div>
      `;
      row.appendChild(card);
    });
    cluster.appendChild(heading);
    cluster.appendChild(row);
    container.appendChild(cluster);
  });
}

async function generateNarrative() {
  const btn = document.getElementById('narrativeBtn');
  if (btn.classList.contains('loading')) return;
  btn.classList.add('loading');
  btn.innerHTML = `
    <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="animation:spin 1s linear infinite"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg>
    Generating…
  `;

  const data = await api('POST', '/narrative', {});
  btn.classList.remove('loading');
  btn.innerHTML = `
    <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>
    Generate Macro Narrative
  `;

  if (!data) {
    showToast('Could not generate narrative — check backend connection');
    return;
  }
  if (data.error) {
    showToast(data.error);
    return;
  }

  // Render themed clusters from AI response
  if (data.themes && data.themes.length > 0) {
    const container = document.getElementById('themeClusters');
    container.innerHTML = '';
    data.themes.forEach((theme, ti) => {
      const cluster = document.createElement('div');
      cluster.className = 'theme-cluster';
      const heading = document.createElement('div');
      heading.className = 'theme-cluster-heading';
      heading.textContent = theme.name;
      const row = document.createElement('div');
      row.className = 'cross-ideas-row';
      (theme.ideas || []).forEach((idea, ii) => {
        const card = document.createElement('div');
        card.className = 'cross-idea-card';
        card.style.animationDelay = `${(ti * 5 + ii) * 0.04}s`;
        card.innerHTML = `
          <div class="cross-idea-book-badge">${idea.bookTitle || ''}</div>
          <div class="cross-idea-title">${idea.ideaTitle || ''}</div>
          <div class="cross-idea-body">${idea.ideaBody || ''}</div>
        `;
        row.appendChild(card);
      });
      cluster.appendChild(heading);
      cluster.appendChild(row);
      container.appendChild(cluster);
    });
  }

  // Show narrative prose
  if (data.narrative) {
    const output = document.getElementById('narrativeOutput');
    const prose = document.getElementById('narrativeProse');
    prose.textContent = data.narrative;
    output.style.display = '';
    output.scrollIntoView({ behavior: 'smooth', block: 'start' });
  }

  showToast('Macro narrative generated');
}

// Swap to real implementation if backend is available
fetch('/api/health').then(r => {
  if (r.ok) {
    window.sendMsg = sendMsgReal;
    loadBooksFromAPI();
    console.log('[WriteFlow] Backend connected ✓');
  }
}).catch(() => {
  console.log('[WriteFlow] Running in prototype mode (no backend)');
});

// ═══════════════════════════════════════
// START
// ═══════════════════════════════════════
init();
</script>
</body>
</html>
